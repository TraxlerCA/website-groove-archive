'use client';

import { useEffect, useMemo, useRef, useState } from 'react';
import { usePlayer } from '@/context/PlayerProvider';
import { SCIcon, YouTubeIcon } from '@/components/icons';
import clsx from 'clsx';

// Tiny inline icons to avoid new deps
const Play = (props: React.SVGProps<SVGSVGElement>) => (
  <svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor" aria-hidden {...props}>
    <path d="M8 5v14l11-7z" />
  </svg>
);
const Pause = (props: React.SVGProps<SVGSVGElement>) => (
  <svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor" aria-hidden {...props}>
    <path d="M6 5h4v14H6zM14 5h4v14h-4z" />
  </svg>
);
const ExternalLink = (props: React.SVGProps<SVGSVGElement>) => (
  <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" strokeWidth="2" aria-hidden {...props}>
    <path d="M14 3h7v7" />
    <path d="M10 14L21 3" />
    <path d="M21 14v7H3V3h7" />
  </svg>
);

function ProgressBar({ value }: { value: number }) {
  return (
    <div className="w-full h-1 rounded-full bg-white/15 overflow-hidden">
      <div
        className="h-full bg-white/80 transition-[width] duration-200"
        style={{ width: `${Math.max(0, Math.min(100, value))}%` }}
      />
    </div>
  );
}

export default function CompactPillPlayer() {
  const { current, playing, toggle } = usePlayer();

  // Guard: render nothing if no track
  if (!current) return null;

  // Map current provider + row to the UI needs
  const title = current.row.set;
  const provider = current.provider; // 'soundcloud' | 'youtube'
  const permalinkUrl = provider === 'soundcloud' ? (current.row.soundcloud || current.row.youtube || '#') : (current.row.youtube || current.row.soundcloud || '#');

  // We only have a 0..1-ish progress value in provider; since it's not exposed here,
  // animate a lightweight micro-progress while playing to provide feedback.
  const [pct, setPct] = useState(0);
  useEffect(() => {
    let raf = 0;
    let last = performance.now();
    const step = (now: number) => {
      const dt = (now - last) / 1000;
      last = now;
      setPct((p) => (playing ? (p + dt * 12) % 100 : p)); // ~8s to full bar; pauses when not playing
      raf = requestAnimationFrame(step);
    };
    raf = requestAnimationFrame(step);
    return () => cancelAnimationFrame(raf);
  }, [playing]);

  const onToggle = () => toggle();

  // Keyboard: space toggles when hovering or focusing the pill
  const wrapRef = useRef<HTMLDivElement>(null);
  useEffect(() => {
    const el = wrapRef.current;
    if (!el) return;

    const onKey = (e: KeyboardEvent) => {
      if (e.code === 'Space' || e.key === ' ') {
        e.preventDefault();
        onToggle();
      }
    };

    // Focus handling
    el.addEventListener('keydown', onKey);

    // Hover handling
    const enter = () => window.addEventListener('keydown', onKey);
    const leave = () => window.removeEventListener('keydown', onKey);
    el.addEventListener('pointerenter', enter);
    el.addEventListener('pointerleave', leave);

    return () => {
      el.removeEventListener('keydown', onKey);
      el.removeEventListener('pointerenter', enter);
      el.removeEventListener('pointerleave', leave);
      window.removeEventListener('keydown', onKey);
    };
  }, [playing]);

  const OpenIcon = provider === 'soundcloud' ? SCIcon : YouTubeIcon;

  return (
    <div
      // Sticky, safe-area aware
      className={clsx(
        'pointer-events-auto fixed inset-x-0 bottom-0 z-40',
        'px-3 pb-[calc(env(safe-area-inset-bottom,0px)+8px)]'
      )}
      aria-live="polite"
    >
      <div
        ref={wrapRef}
        tabIndex={0}
        className={clsx(
          'mx-auto max-w-2xl',
          'rounded-full bg-neutral-900 text-white shadow-2xl ring-1 ring-black/10',
          'px-4 py-2',
          'outline-none focus-visible:ring-2 focus-visible:ring-white/60'
        )}
      >
        <div className="flex items-center gap-3">
          {/* Play / Pause */}
          <button
            aria-label={playing ? 'Pause' : 'Play'}
            onClick={onToggle}
            className="grid place-items-center rounded-full bg-white text-neutral-900 w-11 h-11 active:scale-95"
          >
            {playing ? <Pause className="h-4 w-4" /> : <Play className="h-4 w-4" />}
          </button>

          {/* Title + micro progress */}
          <div className="min-w-0 flex-1">
            <p className="truncate text-sm font-semibold tracking-tight">{title}</p>
            <div className="mt-0.5">
              <ProgressBar value={pct} />
            </div>
          </div>

          {/* Open button with logo (replaces Next) */}
          <a
            href={permalinkUrl}
            target="_blank"
            rel="noopener noreferrer"
            className="inline-flex items-center gap-1.5 rounded-full bg-white text-neutral-900 px-3 h-11 text-xs font-medium shadow ring-1 ring-black/10 hover:bg-neutral-50"
          >
            <OpenIcon className="h-4 w-4" />
            open
            <ExternalLink className="h-4 w-4 opacity-80" />
          </a>
        </div>
      </div>
    </div>
  );
}


