This file is a merged representation of the entire codebase, combining all repository files into a single document.
Generated by Repomix on: 2025-09-06 22:11:34

# File Summary

## Purpose:

This file contains a packed representation of the entire repository's contents.
It is designed to be easily consumable by AI systems for analysis, code review,
or other automated processes.

## File Format:

The content is organized as follows:
1. This summary section
2. Repository information
3. Repository structure
4. Multiple file entries, each consisting of:
   a. A header with the file path (## File: path/to/file)
   b. The full contents of the file in a code block

## Usage Guidelines:

- This file should be treated as read-only. Any changes should be made to the
  original repository files, not this packed version.
- When processing this file, use the file path to distinguish
  between different files in the repository.
- Be aware that this file may contain sensitive information. Handle it with
  the same level of security as you would the original repository.

## Notes:

- Some files may have been excluded based on .gitignore rules and Repomix's
  configuration.
- Binary files are not included in this packed representation. Please refer to
  the Repository Structure section for a complete list of file paths, including
  binary files.

## Additional Information:

For more information about Repomix, visit: https://github.com/andersonby/python-repomix


# Repository Structure

```
.gitignore
eslint.config.mjs
next.config.ts
package.json
postcss.config.mjs
README.md
src
  app
    api
      sheets
        route.ts
      soundcloud-artwork
        route.ts
    globals.css
    heatmaps
      page.tsx
    layout.tsx
    list
      page.tsx
    page.tsx
    serve
      page.tsx
  components
    AppShell.tsx
    CommandBar.tsx
    GlobalMenu.tsx
    Header.tsx
    icons.tsx
    NowPlayingBar.tsx
    player
      CompactPillPlayer.tsx
    PlayerModal.tsx
    ScrollTopFab.tsx
    SuggestModal.tsx
    Thumb.tsx
    ui.tsx
  config.ts
  context
    PlayerProvider.tsx
tsconfig.json
```

# Repository Files


## .gitignore

```text
# See https://help.github.com/articles/ignoring-files/ for more about ignoring files.

# dependencies
/node_modules
/.pnp
.pnp.*
.yarn/*
!.yarn/patches
!.yarn/plugins
!.yarn/releases
!.yarn/versions

# testing
/coverage

# next.js
/.next/
/out/

# production
/build

# misc
.DS_Store
*.pem

# debug
npm-debug.log*
yarn-debug.log*
yarn-error.log*
.pnpm-debug.log*

# env files (can opt-in for committing if needed)
.env*

# vercel
.vercel

# typescript
*.tsbuildinfo
next-env.d.ts
```

## eslint.config.mjs

```text
import { dirname } from "path";
import { fileURLToPath } from "url";
import { FlatCompat } from "@eslint/eslintrc";

const __filename = fileURLToPath(import.meta.url);
const __dirname = dirname(__filename);

const compat = new FlatCompat({
  baseDirectory: __dirname,
});

const eslintConfig = [
  ...compat.extends("next/core-web-vitals", "next/typescript"),
];

export default eslintConfig;
```

## next.config.ts

```typescript
import type { NextConfig } from "next";

const nextConfig: NextConfig = {
  /* config options here */
};

export default nextConfig;
```

## package.json

```json
{
  "name": "website-tga",
  "version": "0.1.0",
  "private": true,
  "scripts": {
    "dev": "next dev --turbopack",
    "build": "next build",
    "start": "next start",
    "lint": "next lint"
  },
  "dependencies": {
    "@tanstack/react-virtual": "^3.13.12",
    "framer-motion": "^12.23.12",
    "html-to-image": "^1.11.13",
    "next": "15.4.6",
    "papaparse": "^5.5.3",
    "xlsx": "^0.18.5",
    "react": "19.1.0",
    "react-dom": "19.1.0"
  },
  "devDependencies": {
    "@eslint/eslintrc": "^3",
    "@tailwindcss/postcss": "^4",
    "@types/node": "^20",
    "@types/papaparse": "^5.3.16",
    "@types/react": "^19",
    "@types/react-dom": "^19",
    "eslint": "^9",
    "eslint-config-next": "15.4.6",
    "tailwindcss": "^4",
    "typescript": "^5"
  }
}
```

## postcss.config.mjs

```text
const config = {
  plugins: ["@tailwindcss/postcss"],
};

export default config;
```

## README.md

````markdown
This is a [Next.js](https://nextjs.org) project bootstrapped with [`create-next-app`](https://nextjs.org/docs/app/api-reference/cli/create-next-app).

## Getting Started

First, run the development server:

```bash
npm run dev
# or
yarn dev
# or
pnpm dev
# or
bun dev
```

Open [http://localhost:3000](http://localhost:3000) with your browser to see the result.

You can start editing the page by modifying `app/page.tsx`. The page auto-updates as you edit the file.

This project uses [`next/font`](https://nextjs.org/docs/app/building-your-application/optimizing/fonts) to automatically optimize and load [Geist](https://vercel.com/font), a new font family for Vercel.

## Learn More

To learn more about Next.js, take a look at the following resources:

- [Next.js Documentation](https://nextjs.org/docs) - learn about Next.js features and API.
- [Learn Next.js](https://nextjs.org/learn) - an interactive Next.js tutorial.

You can check out [the Next.js GitHub repository](https://github.com/vercel/next.js) - your feedback and contributions are welcome!

## Deploy on Vercel

The easiest way to deploy your Next.js app is to use the [Vercel Platform](https://vercel.com/new?utm_medium=default-template&filter=next.js&utm_source=create-next-app&utm_campaign=create-next-app-readme) from the creators of Next.js.

Check out our [Next.js deployment documentation](https://nextjs.org/docs/app/building-your-application/deploying) for more details.
````

## src/app/api/sheets/route.ts

```typescript
// app/api/sheets/route.ts
import { NextResponse } from "next/server";

// register tabs: use your two CSV links
const TABS = [
  {
    key: "list",
    url: "https://docs.google.com/spreadsheets/d/e/2PACX-1vRexqa-1vfj-JdFSSFUjWycho-00d5rLdS76eBgvCbruyvtcVIIom-VM52SvfuhLg-CeHLRp2I6k5B2/pub?gid=950522831&single=true&output=csv",
    map: "list" as const,
  },
  {
    key: "genres", // dimension table with labels + explanations
    url: "https://docs.google.com/spreadsheets/d/e/2PACX-1vRexqa-1vfj-JdFSSFUjWycho-00d5rLdS76eBgvCbruyvtcVIIom-VM52SvfuhLg-CeHLRp2I6k5B2/pub?gid=1479050239&single=true&output=csv",
    map: "genres" as const,
  },
];

export const dynamic = "force-dynamic";

/** Trim, lowercase, and strip BOM if present. */
const norm = (s: string) => (s || "").replace(/^\uFEFF/, "").trim();
const lower = (s: string) => norm(s).toLowerCase();
/** Aggressive header normalization: lowercase, remove BOM, collapse non-alphanumerics */
const normHeader = (s: string) => lower(s).replace(/[^a-z0-9]+/g, " ").trim();

/** Find a header index by any of the provided normalized names. */
const idx = (hdrs: string[], names: string[]) => {
  const H = hdrs.map(normHeader);
  const targets = names.map(normHeader);
  for (const n of targets) {
    const i = H.indexOf(n);
    if (i >= 0) return i;
  }
  return -1;
};
const pick = (cells: string[], i: number) => (i >= 0 ? norm(cells[i] || "") : "");

/** Detect delimiter by scanning the first non-empty logical line, ignoring quoted text. */
function sniffDelimiter(t: string): "," | ";" | "\t" {
  let i = 0;
  while (i < t.length && (t[i] === "\n" || t[i] === "\r")) i++;
  // Look at the first 2 non-empty lines to be safer
  const lines: string[] = [];
  let line = "";
  let q = false;
  for (; i < t.length; i++) {
    const ch = t[i];
    if (q) {
      if (ch === '"' && t[i + 1] === '"') { i++; line += '"'; }
      else if (ch === '"') q = false;
      else line += ch;
    } else {
      if (ch === '"') q = true;
      else if (ch === "\n" || ch === "\r") {
        if (line.trim()) lines.push(line);
        line = "";
        if (lines.length >= 2) break;
      } else {
        line += ch;
      }
    }
  }
  if (line.trim() && lines.length < 2) lines.push(line);

  const targets: Array<"," | ";" | "\t"> = [",", ";", "\t"];
  const score = (s: string, d: string) => {
    // count delimiters not inside quotes (we already removed quoted context)
    return (s.match(new RegExp(`\\${d}`, "g")) || []).length;
  };

  // Pick the delimiter with the highest consistent count across sampled lines
  let best: "," | ";" | "\t" = ",";
  let bestSum = -1;
  for (const d of targets) {
    const total = lines.reduce((acc, ln) => acc + score(ln, d), 0);
    if (total > bestSum) {
      bestSum = total;
      best = d;
    }
  }
  return best;
}

/** CSV/TSV parser with auto delimiter, double-quote escaping, CRLF handling, and BOM removal. */
function parseCSV(t: string) {
  if (!t) return [] as string[][];
  // strip BOM if present
  if (t.charCodeAt(0) === 0xfeff) t = t.slice(1);

  const delim = sniffDelimiter(t);
  const out: string[][] = [];
  let row: string[] = [];
  let cell = "";
  let q = false;

  for (let i = 0; i < t.length; i++) {
    const ch = t[i];
    const nx = t[i + 1];

    if (q) {
      if (ch === '"' && nx === '"') { cell += '"'; i++; }
      else if (ch === '"') { q = false; }
      else { cell += ch; }
      continue;
    }

    if (ch === '"') { q = true; continue; }
    if (ch === delim) { row.push(cell); cell = ""; continue; }
    if (ch === "\n") { row.push(cell); out.push(row); row = []; cell = ""; continue; }
    if (ch === "\r") { continue; }

    cell += ch;
  }
  if (cell.length || row.length) { row.push(cell); out.push(row); }

  // drop fully empty rows
  return out.filter(r => r.some(x => norm(x).length));
}

// fetch one tab
async function fetchTab(url: string) {
  const res = await fetch(url, {
    redirect: "follow",
    cache: "no-store",
    headers: { accept: "text/csv,*/*" },
  });
  if (!res.ok) throw new Error(`fetch failed ${res.status}`);
  let text = await res.text();
  // defensive BOM strip (again)
  if (text.charCodeAt(0) === 0xfeff) text = text.slice(1);

  const mat = parseCSV(text);
  if (!mat.length) return { headers: [] as string[], rows: [] as string[][] };

  // first non-empty row is the header
  const headers = mat[0].map(s => norm(s));
  const body = mat.slice(1);
  return { headers, rows: body };
}

// map "list" to your current Row shape so UI does not change
function map_list(headers: string[], body: string[][]): ListRow[] {
  const iSet  = idx(headers, ["set", "dj set", "mix", "title", "titel", "naam"]);
  const iGen  = idx(headers, ["classification", "genre", "label", "stijl", "genre label"]);
  const iSc   = idx(headers, ["soundcloud", "sc", "soundcloud url", "soundcloud link", "soundcloud_link"]);
  const iYt   = idx(headers, ["youtube", "yt", "youtube url", "youtube link", "youtube_link"]);
  const iTier = idx(headers, ["tier", "rating", "rank", "grade", "s", "score"]);

  return body.map(cells => {
    const set = pick(cells, iSet);
    if (!set) return null;
    const classification = pick(cells, iGen) || null;
    const soundcloud = pick(cells, iSc) || null;
    const youtube = pick(cells, iYt) || null;
    const tier = pick(cells, iTier) || null;

    return { set, classification, soundcloud, youtube, tier };
  }).filter((r): r is ListRow => Boolean(r));
}

// map "genres" dim table to { label, explanation }
function map_genres(headers: string[], body: string[][]): GenreRow[] {
  const iLbl = idx(headers, ["label", "genre", "classification", "naam", "code"]);
  const iExp = idx(headers, ["explanation", "description", "beschrijving", "omschrijving", "uitleg", "notes", "note"]);
  return body.map(cells => ({
    label: pick(cells, iLbl),
    explanation: pick(cells, iExp),
  })).filter(r => r.label);
}

// generic object map if you ever add more dims
function map_raw(headers: string[], body: string[][]) {
  const keys = headers.map(norm);
  return body.map(cells => Object.fromEntries(keys.map((k, i) => [k, norm(cells[i] || "")])));
}

// row interfaces used by the typed cache and mappers
type ListRow = {
  set: string;
  classification: string | null;
  soundcloud: string | null;
  youtube: string | null;
  tier: string | null;
};

type GenreRow = {
  label: string;
  explanation: string;
};

// typed cache
type SheetsData = { list?: ListRow[]; genres?: GenreRow[] } & Record<string, unknown>;
type SheetsPayload = { ok: true; updatedAt: string; data: SheetsData };
type CacheVal = { ts: number; payload: SheetsPayload };

const TTL = 5 * 60 * 1000;

declare global {
  var __sheetCache: Map<string, CacheVal> | undefined;
}
globalThis.__sheetCache = globalThis.__sheetCache ?? new Map<string, CacheVal>();

const getCache = (k: string) => {
  const v = globalThis.__sheetCache!.get(k);
  return v && Date.now() - v.ts < TTL ? v.payload : null;
};
const setCache = (k: string, payload: SheetsPayload) =>
  globalThis.__sheetCache!.set(k, { ts: Date.now(), payload });


// GET /api/sheets?tabs=list,genres
export async function GET(req: Request) {
  try {
    const url = new URL(req.url);
    const only = (url.searchParams.get("tabs") || "").split(",").map(s => s.trim()).filter(Boolean);
    const wanted = only.length ? TABS.filter(t => only.includes(t.key)) : TABS;

    const cacheKey = `tabs:${wanted.map(t => t.key).sort().join(",")}`;
    const cached = getCache(cacheKey);
    if (cached) return NextResponse.json(cached, { headers: { "Cache-Control": "no-store" } });

    const entries = await Promise.all(wanted.map(async t => {
      const { headers, rows } = await fetchTab(t.url);
      let data: ListRow[] | GenreRow[] | Record<string, string>[];
      if (t.map === "list") data = map_list(headers, rows);
      else if (t.map === "genres") data = map_genres(headers, rows);
      else data = map_raw(headers, rows);
      return [t.key, data] as const;
    }));

    const payload: SheetsPayload = {
      ok: true,
      updatedAt: new Date().toISOString(),
      data: Object.fromEntries(entries) as SheetsData,
    };

    setCache(cacheKey, payload);
    return NextResponse.json(payload, { headers: { "Cache-Control": "no-store" } });
  } catch (e: unknown) {
    return NextResponse.json({ ok: false, error: e instanceof Error ? e.message : String(e) }, { status: 500 });
  }
}
```

## src/app/api/soundcloud-artwork/route.ts

```typescript
// src/app/api/soundcloud-artwork/route.ts
import { NextResponse } from "next/server";

type CacheVal = { ts: number; val: string | null };
const TTL = 10 * 60 * 1000;

declare global {
  var __scArtCache: Map<string, CacheVal> | undefined;
}
globalThis.__scArtCache = globalThis.__scArtCache ?? new Map<string, CacheVal>();

function getCached(key: string) {
  const hit = globalThis.__scArtCache!.get(key);
  if (!hit) return null;
  if (Date.now() - hit.ts > TTL) return null;
  return hit.val;
}
function setCached(key: string, val: string | null) {
  globalThis.__scArtCache!.set(key, { ts: Date.now(), val });
}


export async function GET(req: Request) {
  try {
    const url = new URL(req.url);
    const trackUrl = url.searchParams.get("url");
    if (!trackUrl || !/^https?:\/\/(www\.)?soundcloud\.com\//i.test(trackUrl)) {
      return NextResponse.json({ artwork: null }, { status: 400 });
    }

    const key = trackUrl;
    const cached = getCached(key);
    if (cached !== null) {
      return NextResponse.json({ artwork: cached }, { headers: { "Cache-Control": "no-store" } });
    }

    const res = await fetch(
      `https://soundcloud.com/oembed?format=json&url=${encodeURIComponent(trackUrl)}`,
      { headers: { accept: "application/json" } }
    );
    if (!res.ok) {
      setCached(key, null);
      return NextResponse.json({ artwork: null }, { status: 200 });
    }
    const data = (await res.json()) as { thumbnail_url?: string };
    const artwork = data?.thumbnail_url || null;
    setCached(key, artwork);
    return NextResponse.json({ artwork }, { headers: { "Cache-Control": "no-store" } });
  } catch {
    return NextResponse.json({ artwork: null }, { status: 200 });
  }
}
```

## src/app/globals.css

```css
@import "tailwindcss";

/* light base */
html,
body {
  /* was: height: 100%;  → this clamps the page and breaks window virtualizer */
  height: auto;
  min-height: 100%;
  /* Avoid accidental horizontal scrolling on mobile */
  overflow-x: hidden;
  overscroll-behavior-x: contain;
}

body {
  min-height: 100svh;
  -webkit-font-smoothing: antialiased;
  text-rendering: optimizeLegibility;
  font-size: 15px;
  line-height: 1.75;
  /* Restrict touch to vertical pan to avoid sideways swipes */
  touch-action: pan-y;
}

/* media defaults */
img,
video {
  max-width: 100%;
  height: auto;
  display: block;
}

/* focus */
:focus-visible {
  outline: 2px solid rgba(0, 0, 0, 0.35);
  outline-offset: 2px;
}
```

## src/app/heatmaps/page.tsx

```text
'use client';

import React, { useEffect, useMemo, useRef, useState, useCallback } from 'react';
import { motion } from 'framer-motion';
import Papa, { ParseResult } from 'papaparse';
import * as htmlToImage from 'html-to-image';

type Rating = 'nahh' | 'ok' | 'hot' | 'blazing' | '';
type Row = {
  festival: string;  // full title to show
  date: string;      // YYYY-MM-DD
  stage: string;
  stage_order?: string | number;
  artist: string;
  start: string;     // HH:MM
  end: string;       // HH:MM
  rating?: string | null;
};

const COLORS = {
  unrated: '#E7E5E4',
  nahh:    '#8AA3FF',
  ok:      '#FEF0B8',
  hot:     '#FF9D2E',
  blazing: '#E7180B',
};

// rails and ticks
const TIME_W = 96;          // width of the left time rail
const TICK_W = 12;          // horizontal tick length inside time rail
const LABEL_GAP = 10;       // space between tick end and time label

const CARD_BORDER = 'border border-white shadow-[0_1px_2px_rgba(0,0,0,0.06)] rounded-md';

const norm = (v?: string | null) => (v ?? '').replace(/\u00a0/g, ' ').replace(/\s+/g, ' ').trim();
const toMin = (t: string) => {
  const s = norm(t);
  const [h, m] = s.split(':').map(n => parseInt(n, 10));
  return (isNaN(h) ? 0 : h) * 60 + (isNaN(m) ? 0 : m);
};
const clamp = (n: number, min: number, max: number) => Math.max(min, Math.min(max, n));
const parseDate = (d: string) => Date.parse(norm(d));
const bucketFromRating = (s?: string | null): Rating => {
  const v = norm(s).toLowerCase();
  if (v === 'empty') return '';
  if (v === 'nahh' || v === 'nah' || v === 'blue') return 'nahh';
  if (v === 'ok'   || v === 'yellow') return 'ok';
  if (v === 'hot'  || v === 'orange') return 'hot';
  if (v === 'blazing' || v === 'red') return 'blazing';
  return '';
};

type Group = { title: string; date: string; rows: Row[]; key: string };

// Full template CSV (Dekmantel - Saturday)
const TEMPLATE_CSV_DEKMANTEL_SAT = [
  'festival,date,stage,stage_order,artist,start,end,rating',
  'Dekmantel - Saturday,2025-08-02,The Loop,1,MKS,13:00,16:00,ok',
  'Dekmantel - Saturday,2025-08-02,The Loop,1,Bashkka & Roi Perez,16:00,18:00,hot',
  'Dekmantel - Saturday,2025-08-02,The Loop,1,Steffi & Virginia,18:00,19:00,ok',
  'Dekmantel - Saturday,2025-08-02,The Loop,1,Call Super,19:00,21:00,ok',
  'Dekmantel - Saturday,2025-08-02,The Loop,1,Honey Dijon,21:00,23:00,blazing',
  'Dekmantel - Saturday,2025-08-02,UFO I,2,AMORAL,13:00,15:00,',
  'Dekmantel - Saturday,2025-08-02,UFO I,2,Blasha & Allatt,15:00,17:00,',
  'Dekmantel - Saturday,2025-08-02,UFO I,2,MARRØN,17:00,19:00,nahh',
  'Dekmantel - Saturday,2025-08-02,UFO I,2,Freddy K,19:00,21:00,ok',
  'Dekmantel - Saturday,2025-08-02,UFO I,2,Rod & Sterac,21:00,23:00,nahh',
  'Dekmantel - Saturday,2025-08-02,UFO II,3,Loek Frey & Timnah,13:00,16:00,',
  'Dekmantel - Saturday,2025-08-02,UFO II,3,Steevio (live),16:00,17:00,',
  'Dekmantel - Saturday,2025-08-02,UFO II,3,Priori (live),17:00,18:00,nahh',
  'Dekmantel - Saturday,2025-08-02,UFO II,3,KIA,18:00,20:00,ok',
  'Dekmantel - Saturday,2025-08-02,UFO II,3,IMDT (live),20:00,21:00,ok',
  'Dekmantel - Saturday,2025-08-02,UFO II,3,Spekki Webu & Woody92,21:00,23:00,ok',
  'Dekmantel - Saturday,2025-08-02,Selectors,4,Shanti Celeste,13:00,17:00,blazing',
  'Dekmantel - Saturday,2025-08-02,Selectors,4,Casper Tielrooij & Victor,17:00,20:00,blazing',
  'Dekmantel - Saturday,2025-08-02,Selectors,4,Hunee & Paquita Gordon,20:00,23:00,blazing',
  'Dekmantel - Saturday,2025-08-02,Greenhouse,5,Mafalda,13:00,16:30,',
  'Dekmantel - Saturday,2025-08-02,Greenhouse,5,Mark Ernestus’ Ndagga Rhythm Force,16:30,17:30,',
  'Dekmantel - Saturday,2025-08-02,Greenhouse,5,Moda & Wolfers,18:00,19:00,nahh',
  'Dekmantel - Saturday,2025-08-02,Greenhouse,5,The Sabres of Paradise,19:30,20:30,nahh',
  'Dekmantel - Saturday,2025-08-02,Greenhouse,5,dBridge & Donato Dozzy,20:30,23:00,ok',
  'Dekmantel - Saturday,2025-08-02,The Nest,6,State Offf,13:00,15:30,',
  'Dekmantel - Saturday,2025-08-02,The Nest,6,Kampire,15:30,16:30,',
  'Dekmantel - Saturday,2025-08-02,The Nest,6,De Schuurman & Shaun D,16:30,18:00,',
  'Dekmantel - Saturday,2025-08-02,The Nest,6,DJ K,18:00,19:00,nahh',
  'Dekmantel - Saturday,2025-08-02,The Nest,6,Moktar & Surusinghe,19:00,21:00,ok',
  'Dekmantel - Saturday,2025-08-02,The Nest,6,Verraco,21:00,23:00,ok',
  'Dekmantel - Saturday,2025-08-02,Radar,7,Om Unit – Acid Dub Studies (live),14:00,15:00,',
  'Dekmantel - Saturday,2025-08-02,Radar,7,Ploy,15:00,16:00,',
  'Dekmantel - Saturday,2025-08-02,Radar,7,Kia,16:00,17:00,',
  'Dekmantel - Saturday,2025-08-02,Radar,7,Shed (live),17:15,18:15,',
  'Dekmantel - Saturday,2025-08-02,Radar,7,Batu,18:15,19:15,nahh',
  'Dekmantel - Saturday,2025-08-02,Radar,7,Mad Miran,19:15,20:15,nahh',
  'Dekmantel - Saturday,2025-08-02,Radar,7,Djrum,20:30,21:45,nahh',
  'Dekmantel - Saturday,2025-08-02,Radar,7,Quest,22:00,23:00,ok',
].join('\n');

// First 5 rows for example table
const TEMPLATE_FIRST5: Row[] = [
  { festival: 'Dekmantel - Saturday', date: '2025-08-02', stage: 'The Loop', stage_order: 1, artist: 'MKS', start: '13:00', end: '16:00', rating: 'ok' },
  { festival: 'Dekmantel - Saturday', date: '2025-08-02', stage: 'The Loop', stage_order: 1, artist: 'Bashkka & Roi Perez', start: '16:00', end: '18:00', rating: 'hot' },
  { festival: 'Dekmantel - Saturday', date: '2025-08-02', stage: 'The Loop', stage_order: 1, artist: 'Steffi & Virginia', start: '18:00', end: '19:00', rating: 'ok' },
  { festival: 'Dekmantel - Saturday', date: '2025-08-02', stage: 'The Loop', stage_order: 1, artist: 'Call Super', start: '19:00', end: '21:00', rating: 'ok' },
  { festival: 'Dekmantel - Saturday', date: '2025-08-02', stage: 'The Loop', stage_order: 1, artist: 'Honey Dijon', start: '21:00', end: '23:00', rating: 'blazing' },
];

export default function HeatmapsPage() {
  const DEFAULT_CSV =
    'https://docs.google.com/spreadsheets/d/e/2PACX-1vRexqa-1vfj-JdFSSFUjWycho-00d5rLdS76eBgvCbruyvtcVIIom-VM52SvfuhLg-CeHLRp2I6k5B2/pub?gid=116583245&single=true&output=csv';
  const CSV_URL =
    typeof window !== 'undefined'
      ? new URLSearchParams(location.search).get('csv') || DEFAULT_CSV
      : DEFAULT_CSV;

  // curated data fetched from the default CSV (existing behavior)
  const [rows, setRows] = useState<Row[]>([]);
  // user-provided preview rows (ephemeral)
  const [userRows, setUserRows] = useState<Row[]>([]);
  const [uploadOpen, setUploadOpen] = useState(false);
  // Fixed density (removed slider)
  const pxPerMin = 1.0;
  const [err, setErr] = useState<string | null>(null);
  const refs = useRef<Record<string, HTMLDivElement | null>>({});

  useEffect(() => {
    Papa.parse<Row>(CSV_URL, {
      download: true, header: true, skipEmptyLines: true,
      complete: (res: ParseResult<Row>) => {
        const clean = (res.data || [])
          .map(r => ({
            festival: norm(r.festival),
            date: norm(r.date),
            stage: norm(r.stage),
            stage_order: Number(r.stage_order ?? 9999),
            artist: norm(r.artist),
            start: norm(r.start),
            end: norm(r.end),
            rating: norm(r.rating || ''),
          }))
          .filter(r => r.festival && r.date && r.stage && r.artist && r.start && r.end);
        setRows(clean);
      }
    });
  }, [CSV_URL]);

  const groups: Group[] = useMemo(() => {
    const map = new Map<string, Group>();
    for (const r of rows) {
      const key = `${r.festival}__${r.date}`;
      if (!map.has(key)) map.set(key, { title: r.festival, date: r.date, rows: [], key });
      map.get(key)!.rows.push(r);
    }
    return Array.from(map.values()).sort((a, b) => parseDate(b.date) - parseDate(a.date));
  }, [rows]);

  const userGroups: Group[] = useMemo(() => {
    if (!userRows.length) return [];
    const map = new Map<string, Group>();
    for (const r of userRows) {
      const key = `${r.festival}__${r.date}`;
      if (!map.has(key)) map.set(key, { title: r.festival, date: r.date, rows: [], key });
      map.get(key)!.rows.push(r);
    }
    return Array.from(map.values()).sort((a, b) => parseDate(a.date) - parseDate(b.date));
  }, [userRows]);

  const slugify = (s: string) => s
    .toLowerCase()
    .replace(/[^a-z0-9]+/g, '-')
    .replace(/^-+|-+$/g, '')
    .slice(0, 120);

  async function exportPng(key: string, title: string) {
    const el = refs.current[key]; if (!el) return;
    setErr(null);
    try {
      const dataUrl = await htmlToImage.toPng(el, {
        pixelRatio: 2, backgroundColor: '#ffffff', cacheBust: true, skipFonts: true
      });
      try { (window as unknown as { plausible?: (e: string) => void }).plausible?.('heatmap_download_png'); } catch {}
      const a = document.createElement('a'); a.href = dataUrl; a.download = `${slugify(title)}-heatmap.png`; a.click();
    } catch (e: unknown) { setErr(e instanceof Error ? e.message : 'Export failed'); console.error(e); }
  }

  return (
    <div className="mx-auto max-w-6xl px-6 py-6">
      <CreateHeatmapModal
        open={uploadOpen}
        onClose={() => setUploadOpen(false)}
        onApply={(rows) => { setUserRows(rows); setUploadOpen(false); }}
      />
      {/* Hero CTA: dominant primary action */}
      <div className="mb-10 rounded-2xl border border-neutral-200 bg-white p-6 sm:p-10 shadow-sm">
        <div className="grid items-center gap-6 sm:grid-cols-[1fr_auto]">
          <div>
            <h1 className="text-2xl sm:text-4xl font-semibold tracking-wide text-neutral-900">Create your own heatmap</h1>
            <p className="mt-2 text-sm sm:text-base text-neutral-600">Upload a CSV, preview instantly, and download a PNG. All processing stays in your browser.</p>
          </div>
          <div className="flex flex-wrap items-center gap-3">
            <motion.button
              className="h-12 rounded-md bg-neutral-900 px-6 text-white shadow hover:bg-neutral-800 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-black/30"
              onClick={() => setUploadOpen(true)}
              whileHover={{ y: -1, scale: 1.01 }}
              whileTap={{ y: 0, scale: 0.99 }}
            >
              Create your own heatmap
            </motion.button>
            <motion.button
              className="h-12 rounded-md border border-neutral-300 bg-white px-4 text-sm hover:bg-neutral-50"
              onClick={() => {
                const blob = new Blob([TEMPLATE_CSV_DEKMANTEL_SAT], { type: 'text/csv;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a'); a.href = url; a.download = 'heatmap-template.csv'; a.click();
                URL.revokeObjectURL(url);
              }}
            >
              CSV template
            </motion.button>
          </div>
        </div>
      </div>

      {err && <div className="mb-4 rounded-md border border-red-200 bg-red-50 px-3 py-2 text-sm text-red-700">{err}</div>}

      {/* user preview above curated heatmaps */}
      {userGroups.length > 0 && (
        <div className="mb-10 space-y-8">
          <div className="mb-1 flex items-center justify-between">
            <h2 className="text-3xl font-semibold tracking-wide text-neutral-900">Your preview</h2>
            <div className="flex items-center gap-2">
              <button
                className="rounded-md border border-neutral-300 bg-white px-3 py-2 text-sm hover:bg-neutral-50"
                onClick={() => setUserRows([])}
              >
                Clear preview
              </button>
            </div>
          </div>
          {userGroups.map(g => (
            <Heatmap
              key={'user__' + g.key}
              groupKey={'user__' + g.key}
              title={g.title}
              date={g.date}
              rows={g.rows}
              pxPerMin={pxPerMin}
              registerRef={el => (refs.current['user__' + g.key] = el)}
              onExport={() => exportPng('user__' + g.key, `${g.title}-${g.date}`)}
            />
          ))}
        </div>
      )}

      {/* curated examples */}
      <h2 className="mb-4 text-3xl font-semibold tracking-wide text-neutral-900">Example heatmaps</h2>
      <div className="space-y-12">
        {groups.map(g => (
          <Heatmap
            key={g.key}
            groupKey={g.key}
            title={g.title}
            date={g.date}
            rows={g.rows}
            pxPerMin={pxPerMin}
            registerRef={el => (refs.current[g.key] = el)}
            onExport={() => exportPng(g.key, `${g.title}-${g.date}`)}
          />
        ))}
      </div>
    </div>
  );
}

/* one heatmap */
function Heatmap({
  groupKey, title, date, rows, pxPerMin, registerRef, onExport,
}: {
  groupKey: string; title: string; date: string; rows: Row[];
  pxPerMin: number; registerRef: (el: HTMLDivElement | null) => void; onExport: () => void;
}) {
  const stages = useMemo(() => {
    const map = new Map<string, number>();
    rows.forEach(r => {
      const ord = Number(r.stage_order ?? 9999);
      map.set(r.stage, Math.min(map.get(r.stage) ?? ord, ord));
    });
    return Array.from(map.entries()).sort((a, b) => a[1] - b[1]).map(([s]) => s);
  }, [rows]);

  // midnight handling with 10:00 cutoff
  const DAY = 24 * 60;
  const NIGHT_CUTOFF_H = 10;           // anything earlier is treated as next day
  const CUTOFF = NIGHT_CUTOFF_H * 60;

  const startMin = React.useCallback((r: Row) => {
    const s = toMin(r.start);
    return s < CUTOFF ? s + DAY : s;
  }, [CUTOFF, DAY]);
  const endMin = React.useCallback((r: Row) => {
    const s = startMin(r);
    let e = toMin(r.end);
    e = e < CUTOFF ? e + DAY : e;
    if (e <= s) e += DAY; // safety for 22:00→01:00 and odd cases
    return e;
  }, [startMin, CUTOFF, DAY]);
  const fmtHour = (mins: number) => {
    const hr = Math.floor((((mins % DAY) + DAY) % DAY) / 60);
    return String(hr).padStart(2, '0') + ':00';
  };

  const minStart = useMemo(() => Math.min(...rows.map(r => startMin(r))), [rows, startMin]);
  const maxEnd   = useMemo(() => Math.max(...rows.map(r => endMin(r))),   [rows, endMin]);
  const totalMin = clamp(Math.max(60, maxEnd - minStart), 60, 20 * 60);
  const heightPx = Math.round(totalMin * pxPerMin);

  const hours = useMemo(() => {
    const s = Math.floor(minStart / 60), e = Math.ceil(maxEnd / 60);
    return Array.from({ length: Math.max(0, e - s + 1) }, (_, i) => (s + i) * 60);
  }, [minStart, maxEnd]);

  return (
    <section aria-labelledby={`h-${groupKey}`}>
      <div className="mb-2 flex items-center justify-between">
        <h2 id={`h-${groupKey}`} className="text-2xl font-semibold tracking-wide text-neutral-900">
          {title}
        </h2>
        <div className="flex items-center gap-3">
          <span className="text-sm text-neutral-500">{date}</span>
          <motion.button
            className="rounded-md bg-neutral-900 px-3 py-2 text-sm text-white hover:bg-neutral-800"
            onClick={onExport}
            whileHover={{ y: -1, scale: 1.01 }}
            whileTap={{ y: 0, scale: 0.99 }}
          >
            Export PNG
          </motion.button>
        </div>
      </div>

      {/* wrapper has no background */}
      <div ref={registerRef} className="rounded-xl border border-neutral-200 p-4">
        {/* legend above stage names */}
        <div className="mb-2 flex flex-wrap items-center gap-5 text-sm text-neutral-700">
          <span className="inline-flex items-center gap-2"><i className="inline-block h-3 w-6 rounded" style={{ backgroundColor: COLORS.nahh }} /> nahh</span>
          <span className="inline-flex items-center gap-2"><i className="inline-block h-3 w-6 rounded" style={{ backgroundColor: COLORS.ok }} /> ok</span>
          <span className="inline-flex items-center gap-2"><i className="inline-block h-3 w-6 rounded" style={{ backgroundColor: COLORS.hot }} /> hot</span>
          <span className="inline-flex items-center gap-2"><i className="inline-block h-3 w-6 rounded" style={{ backgroundColor: COLORS.blazing }} /> blazing</span>
        </div>
        {/* headers with vertical black dividers */}
        <div className="flex items-stretch">
          <div style={{ width: TIME_W }} />
          <div className="grid w-full gap-0" style={{ gridTemplateColumns: `repeat(${stages.length}, minmax(0, 1fr))` }}>
            {stages.map((s, i) => (
              <div
                key={s}
                className={`text-center text-[16px] font-bold text-neutral-900 border-r border-black ${i === stages.length - 1 ? 'border-r-0' : ''} py-1`}
              >
                {s}
              </div>
            ))}
          </div>
        </div>

        {/* body */}
        <div className="mt-2 flex items-stretch">
          {/* time rail with ticks and labels */}
          <div className="relative" style={{ width: TIME_W, height: heightPx }}>
            {hours.map(h => (
              <div
                key={`tick-${h}`}
                className="absolute right-0 h-px bg-black"
                style={{ top: (h - minStart) * pxPerMin, width: TICK_W }}
              />
            ))}
            {hours.map(h => (
              <div
                key={`lab-${h}`}
                className="absolute -translate-y-3 text-[16px] font-bold tabular-nums text-neutral-900"
                style={{ top: (h - minStart) * pxPerMin, right: TICK_W + LABEL_GAP }}
              >
                {fmtHour(h)}
              </div>
            ))}
          </div>

          {/* stage area with global grid lines */}
          <div className="relative w-full" style={{ height: heightPx }}>
            {/* black horizontal lines across all stages */}
            <div className="pointer-events-none absolute inset-0">
              {hours.map(h => (
                <div
                  key={`hline-${h}`}
                  className="absolute left-0 right-0 h-px bg-black"
                  style={{ top: (h - minStart) * pxPerMin }}
                />
              ))}
            </div>

            {/* columns with black vertical separators */}
            <div className="relative grid h-full gap-0" style={{ gridTemplateColumns: `repeat(${stages.length}, minmax(0, 1fr))` }}>
              {stages.map((stage, idx) => {
                const sets = rows
                  .filter(r => r.stage === stage)
                  .sort((a, b) => startMin(a) - startMin(b));

                return (
                  <div key={stage} className={`relative border-r border-black ${idx === stages.length - 1 ? 'border-r-0' : ''}`}>
                    {sets.map((r, i) => {
                      const s = startMin(r);
                      const e = endMin(r);
                      const naturalTop = (s - minStart) * pxPerMin;
                      const naturalH   = Math.max(28, (e - s) * pxPerMin);
                      const innerH = naturalH * 0.95;                  // 95% height
                      const top = naturalTop + (naturalH - innerH) / 2;

                      const bucket = bucketFromRating(r.rating);
                      const bg = bucket ? COLORS[bucket] : COLORS.unrated;
                      const txt = (bucket === 'ok' || bucket === '') ? '#111827' : '#FFFFFF';

                      return (
                        <div key={stage + '-' + i} className="absolute left-2 right-2" style={{ top }}>
                          <div
                            className={`${CARD_BORDER} flex items-center justify-center text-center px-2`}
                            style={{ height: innerH, backgroundColor: bg, color: txt }}
                          >
                            <div className="text-[13px] leading-snug">{r.artist}</div>
                          </div>
                        </div>
                      );
                    })}
                  </div>
                );
              })}
            </div>
          </div>
        </div>
      </div>
    </section>
  );
}

/* Upload modal */
function CreateHeatmapModal({
  open, onClose, onApply,
}: {
  open: boolean;
  onClose: () => void;
  onApply: (rows: Row[]) => void;
}) {
  const dialogRef = useRef<HTMLDivElement | null>(null);
  const [errors, setErrors] = useState<string[]>([]);
  const [parsedRows, setParsedRows] = useState<Row[] | null>(null);

  // focus trap + esc close
  useEffect(() => {
    if (!open) return;
    const dialog = dialogRef.current;
    const prev = document.activeElement as HTMLElement | null;
    const focusables = () => Array.from(dialog?.querySelectorAll<HTMLElement>(
      'a[href], button, textarea, input, select, [tabindex]:not([tabindex="-1"])'
    ) || []).filter(el => !el.hasAttribute('disabled'));
    const first = () => focusables()[0];
    const last = () => focusables()[focusables().length - 1];
    const onKey = (e: KeyboardEvent) => {
      if (e.key === 'Escape') { e.preventDefault(); onClose(); }
      if (e.key === 'Tab') {
        const f = focusables(); if (!f.length) return;
        const current = document.activeElement as HTMLElement | null;
        if (e.shiftKey) {
          if (current === f[0] || !dialog?.contains(current)) { e.preventDefault(); last()?.focus(); }
        } else {
          if (current === f[f.length - 1] || !dialog?.contains(current)) { e.preventDefault(); first()?.focus(); }
        }
      }
    };
    document.addEventListener('keydown', onKey);
    // initial focus
    setTimeout(() => first()?.focus(), 0);
    return () => {
      document.removeEventListener('keydown', onKey);
      prev?.focus();
    };
  }, [open, onClose]);

  const normalizeTime = (t: string) => {
    const s = (t || '').trim();
    const m = s.match(/^(\d{1,2}):(\d{2})$/);
    if (!m) return null;
    const hh = String(Math.max(0, Math.min(29, parseInt(m[1], 10)))).padStart(2, '0');
    const mm = String(Math.max(0, Math.min(59, parseInt(m[2], 10)))).padStart(2, '0');
    return `${hh}:${mm}`;
  };

  const validateAndParse = useCallback(async (text: string) => {
    const errs: string[] = [];
    const bytes = new Blob([text]).size;
    if (bytes > 1_000_000) errs.push('File is larger than 1 MB.');

    const res = await new Promise<ParseResult<Record<string, unknown>>>((resolve) => {
      Papa.parse(text, { header: true, skipEmptyLines: true, complete: resolve });
    });

    const fields = (res.meta.fields || []).map(f => (f || '').trim().toLowerCase());
    const required = ['festival','date','stage','artist','start','end','rating'];
    const missing = required.filter(r => !fields.includes(r));
    if (missing.length) errs.push(`Missing required columns: ${missing.join(', ')}`);

    const rawRows = (res.data || []) as Array<Record<string, unknown>>;
    if (rawRows.length > 200) errs.push('Too many rows. Maximum is 200.');

    const cleanRows: Row[] = [];
    const dateRe = /^\d{4}-\d{2}-\d{2}$/;
    rawRows.forEach((r, idx) => {
      const rowNum = idx + 2; // header is row 1
      const g = (k: string) => (r?.[k] ?? '').toString();

      const festival = norm(g('festival'));
      const date = norm(g('date'));
      const stage = norm(g('stage'));
      const artist = norm(g('artist'));
      const start = norm(g('start'));
      const end = norm(g('end'));
      let rating = norm(g('rating')).toLowerCase();
      const stage_order_raw = g('stage_order');

      if (!festival) errs.push(`Row ${rowNum} is missing festival.`);
      if (!date || !dateRe.test(date)) errs.push(`Row ${rowNum} has an invalid date. Use YYYY-MM-DD like 2025-07-31.`);
      if (!stage) errs.push(`Row ${rowNum} is missing stage.`);
      if (!artist) errs.push(`Row ${rowNum} is missing artist.`);

      const ns = normalizeTime(start);
      const ne = normalizeTime(end);
      if (!ns) errs.push(`Row ${rowNum} has an invalid time. Use HH:MM like 23:45.`);
      if (!ne) errs.push(`Row ${rowNum} has an invalid time. Use HH:MM like 23:45.`);

      if (rating === 'empty') rating = '';
      const allowedRating = ['','nahh','ok','hot','blazing'];
      if (!allowedRating.includes(rating)) errs.push(`Row ${rowNum} has an invalid rating. Use nahh|ok|hot|blazing|empty.`);

      let stage_order: number | undefined = undefined;
      const so = norm(stage_order_raw);
      if (so) {
        const n = Number(so);
        if (!Number.isFinite(n)) errs.push(`Row ${rowNum} has an invalid stage_order. Use a number like 1, 2, 3.`);
        else stage_order = n;
      }

      if (festival && date && stage && artist && ns && ne && allowedRating.includes(rating)) {
        cleanRows.push({ festival, date, stage, stage_order, artist, start: ns, end: ne, rating });
      }
    });

    setErrors(errs);
    if (errs.length) { setParsedRows(null); return null; }
    setParsedRows(cleanRows);
    return cleanRows;
  }, []);

  const onFile = useCallback(async (file: File) => {
    setErrors([]); setParsedRows(null);
    try {
      if (file.size > 1_000_000) { setErrors(['File is larger than 1 MB.']); return; }
      let text: string;
      const lower = (file.name || '').toLowerCase();
      const isXlsx = lower.endsWith('.xlsx') || file.type.includes('spreadsheetml');
      if (isXlsx) {
        // Parse XLSX in-browser and convert to CSV using SheetJS
        const XLSX = await import('xlsx');
        const ab = await file.arrayBuffer();
        const wb = XLSX.read(ab, { type: 'array' });
        const ws = wb.Sheets[wb.SheetNames[0]];
        text = XLSX.utils.sheet_to_csv(ws);
      } else {
        text = await file.text();
      }
      await validateAndParse(text);
      // optional analytics
      try { (window as unknown as { plausible?: (e: string) => void }).plausible?.('heatmap_upload_success'); } catch {}
    } finally {
      // no-op
    }
  }, [validateAndParse]);

  const apply = useCallback(() => {
    if (!parsedRows || parsedRows.length === 0) return;
    onApply(parsedRows);
    onClose();
  }, [parsedRows, onApply, onClose]);

  if (!open) return null;
  return (
    <div className="fixed inset-0 z-50">
      <div className="absolute inset-0 bg-black/50" onClick={onClose} aria-hidden />
      <div
        ref={dialogRef}
        role="dialog" aria-modal="true" aria-labelledby="csv-title" aria-describedby="csv-desc"
        className="absolute inset-x-0 top-6 mx-auto w-[min(800px,92vw)] rounded-xl border border-neutral-200 bg-white p-4 shadow-2xl"
        onClick={e => e.stopPropagation()}
      >
        <div className="mb-3 flex items-start justify-between gap-3">
          <div>
            <h2 id="csv-title" className="text-lg font-semibold tracking-wide text-neutral-900">Create your own heatmap</h2>
            <p id="csv-desc" className="text-sm text-neutral-600">
              Upload a CSV or Excel (.xlsx). Required columns: festival, date (YYYY-MM-DD), stage, artist, start (HH:MM), end (HH:MM), rating (nahh|ok|hot|blazing|empty).
            </p>
          </div>
        </div>

        <div className="grid gap-3 sm:grid-cols-2">
          <div className="rounded-lg border border-neutral-200 p-3">
            <label className="mb-2 block text-sm font-medium text-neutral-800">Upload CSV or Excel (.xlsx)</label>
            <input
              type="file" accept=".csv,.xlsx,text/csv,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" onChange={e => { const f = (e.target as HTMLInputElement).files?.[0]; if (f) onFile(f); }}
              className="block w-full text-sm file:mr-3 file:rounded-md file:border file:border-neutral-900 file:bg-neutral-900 file:text-white file:px-3 file:py-1.5 file:text-sm file:hover:bg-neutral-800"
            />
            <p className="mt-2 text-xs text-neutral-500">Max 1 MB, 200 rows. CSV delimiters , or ; supported. Excel files are converted automatically.</p>
          </div>

          {/* Example table: first 5 rows */}
          <div className="rounded-lg border border-neutral-200 p-3 overflow-x-auto">
            <label className="mb-2 block text-sm font-medium text-neutral-800">Format example (first 5 rows)</label>
            <table className="w-full text-xs">
              <thead>
                <tr className="text-left text-neutral-600">
                  <th className="px-2 py-1">festival</th>
                  <th className="px-2 py-1">date</th>
                  <th className="px-2 py-1">stage</th>
                  <th className="px-2 py-1">stage_order</th>
                  <th className="px-2 py-1">artist</th>
                  <th className="px-2 py-1">start</th>
                  <th className="px-2 py-1">end</th>
                  <th className="px-2 py-1">rating</th>
                </tr>
              </thead>
              <tbody>
                {TEMPLATE_FIRST5.map((r, i) => (
                  <tr key={i} className="border-t border-neutral-200">
                    <td className="px-2 py-1 whitespace-nowrap">{r.festival}</td>
                    <td className="px-2 py-1 whitespace-nowrap">{r.date}</td>
                    <td className="px-2 py-1 whitespace-nowrap">{r.stage}</td>
                    <td className="px-2 py-1 whitespace-nowrap">{String(r.stage_order ?? '')}</td>
                    <td className="px-2 py-1 whitespace-nowrap">{r.artist}</td>
                    <td className="px-2 py-1 whitespace-nowrap">{r.start}</td>
                    <td className="px-2 py-1 whitespace-nowrap">{r.end}</td>
                    <td className="px-2 py-1 whitespace-nowrap">{r.rating}</td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        </div>

        {errors.length > 0 && (
          <div className="mt-3 rounded-md border border-red-200 bg-red-50 p-3 text-sm text-red-700">
            <ul className="list-disc pl-5">
              {errors.map((e, i) => <li key={i}>{e}</li>)}
            </ul>
          </div>
        )}

        {parsedRows && errors.length === 0 && (
          <div className="mt-3 rounded-md border border-emerald-200 bg-emerald-50 p-3 text-sm text-emerald-800">
            Looks good! Parsed {parsedRows.length} rows. Click “Add preview” to render above.
          </div>
        )}

        <div className="mt-4 flex items-center justify-end gap-2">
          <motion.button className="rounded-md border border-neutral-300 bg-white px-3 py-2 text-sm hover:bg-neutral-50" onClick={onClose}
            whileHover={{ y: -1, scale: 1.01 }} whileTap={{ y: 0, scale: 0.99 }}
          >Cancel</motion.button>
          <motion.button
            className="rounded-md bg-neutral-900 px-3 py-2 text-sm text-white disabled:opacity-50"
            onClick={apply}
            disabled={!parsedRows || !!errors.length}
            whileHover={{ y: -1, scale: 1.01 }} whileTap={{ y: 0, scale: 0.99 }}
          >
            Add preview
          </motion.button>
        </div>
      </div>

      {/* inline legend per heatmap */}
      <div className="mb-2 flex flex-wrap items-center gap-5 text-sm text-neutral-700">
        <span className="inline-flex items-center gap-2"><i className="inline-block h-3 w-6 rounded" style={{ backgroundColor: COLORS.nahh }} /> nahh</span>
        <span className="inline-flex items-center gap-2"><i className="inline-block h-3 w-6 rounded" style={{ backgroundColor: COLORS.ok }} /> ok</span>
        <span className="inline-flex items-center gap-2"><i className="inline-block h-3 w-6 rounded" style={{ backgroundColor: COLORS.hot }} /> hot</span>
        <span className="inline-flex items-center gap-2"><i className="inline-block h-3 w-6 rounded" style={{ backgroundColor: COLORS.blazing }} /> blazing</span>
      </div>
    </div>
  );
}
```

## src/app/layout.tsx

```text
// src/app/layout.tsx
import './globals.css';
import type { ReactNode } from 'react';
import type { Metadata } from 'next';
import { PlayerProvider } from '@/context/PlayerProvider';
import AppShell from '@/components/AppShell';

export const metadata: Metadata = {
  icons: {
    icon: [{ url: '/icons/icon_list.png', type: 'image/png', sizes: 'any' }],
    shortcut: ['/icons/icon_list.png'],
    apple: [{ url: '/icons/icon_list.png' }],
  },
};

export default function RootLayout({ children }: { children: ReactNode }) {
  return (
    <html lang="en">
      <body className="min-h-screen bg-neutral-50 text-neutral-800 font-sans relative overflow-x-hidden">
        {/* light theme variables for any legacy components that still reference them */}
        <style>{`:root{--accent:#000000;--label:#737373;--radius:0.75rem;--sodium:#000000}`}</style>
        <PlayerProvider>
          <AppShell>{children}</AppShell>
        </PlayerProvider>
      </body>
    </html>
  );
}
```

## src/app/list/page.tsx

```text
// src/app/list/page.tsx
'use client';

import { useCallback, useEffect, useMemo, useRef, useState } from "react";
import { useWindowVirtualizer } from "@tanstack/react-virtual";
import { IconButton, PageTitle, Tag } from "@/components/ui";
import { YouTubeIcon, SCIcon, SearchIcon, PaperPlaneOutlineIcon } from "@/components/icons";
import { usePlayer } from "@/context/PlayerProvider";
import { useRows } from "@/lib/useRows";
import SuggestModal from "@/components/SuggestModal";
import { motion } from 'framer-motion';

/* title | genre | links */
/*
  Make column widths responsive to avoid overflow on small screens.
  - `title` flexes
  - `genre` shrinks on small screens but caps at 220px
  - `links` shrinks on small screens but caps at 88px
*/
const ROW_COLS =
  "grid grid-cols-[minmax(0,1fr)_clamp(7rem,28vw,220px)_clamp(5rem,18vw,88px)] items-center gap-3";

export default function ListPage() {
  const { rows, loading } = useRows();
  const { play } = usePlayer();

  const [q, setQ] = useState("");
  const [genre, setGenre] = useState("any");
  const [suggestOpen, setSuggestOpen] = useState(false);
  const suggestBtnRef = useRef<HTMLButtonElement | null>(null);

  const genres = useMemo(() => {
    const s = new Set<string>();
    rows.forEach(r => {
      const g = (r.classification || "").trim();
      if (g) s.add(g);
    });
    return ["any", ...Array.from(s).sort()];
  }, [rows]);

  const filtered = useMemo(() => {
    const term = q.trim().toLowerCase();
    return rows.filter(r => {
      if (genre !== "any" && r.classification !== genre) return false;
      if (!term) return true;
      const hay = `${r.set} ${(r.classification || "")} ${(r.tier || "")}`.toLowerCase();
      return term.split(/\s+/).filter(Boolean).every(w => hay.includes(w));
    });
  }, [rows, q, genre]);

  // Keep estimate stable; recompute after mount based on width
  const [isNarrow, setIsNarrow] = useState(false);
  useEffect(() => {
    const update = () => setIsNarrow(window.innerWidth < 640);
    update();
    window.addEventListener("resize", update);
    return () => window.removeEventListener("resize", update);
  }, []);

  const estimateSize = useCallback(() => (isNarrow ? 96 : 56), [isNarrow]);

  const rowVirtualizer = useWindowVirtualizer({
    count: loading ? 20 : filtered.length,
    estimateSize,
    overscan: 8,
  });

  return (
    <section className="container mx-auto max-w-6xl px-6 mt-10 space-y-10">
      <PageTitle title="THE LIST" />

      <div className="rounded-2xl border border-neutral-200 overflow-hidden bg-white">
        <div>
          {/* Sticky header */}
          <div className="sticky top-0 z-10 bg-white/95 backdrop-blur">
            {/* Filters */}
            <div className="flex flex-wrap items-center gap-3 px-3 py-2 border-b border-neutral-200">
              <div className="flex items-center gap-2">
                <span className="text-xs font-medium tracking-widest text-neutral-500">Search</span>
                <label className="flex items-center gap-2 rounded-lg border border-neutral-300 bg-white px-2 h-9">
                  <SearchIcon />
                  <input
                    value={q}
                    onChange={e => setQ(e.target.value)}
                    className="outline-none text-[16px] sm:text-sm w-56"
                    placeholder="Type to filter"
                  />
                </label>
              </div>

              {/* genre dropdown */}
              <div className="flex items-center gap-3">
                <span className="text-xs font-medium tracking-widest text-neutral-500">Genre</span>
                <span className="relative inline-flex items-center h-9 px-3 rounded-lg border border-neutral-300 bg-white">
                  <select
                    value={genre}
                    onChange={e => setGenre(e.target.value)}
                    className="appearance-none bg-transparent outline-none text-sm pr-5"
                  >
                    {genres.map(g => (
                      <option key={g} value={g}>
                        {g === "any" ? "Any" : g}
                      </option>
                    ))}
                  </select>
                  <svg width="16" height="16" viewBox="0 0 20 20" className="absolute right-1 pointer-events-none">
                    <path d="M5 7l5 6 5-6" fill="none" stroke="#000" strokeWidth="1.5" />
                  </svg>
                </span>
              </div>

              {/* Suggest a set action */}
              <div className="ml-auto">
                <motion.button
                  ref={suggestBtnRef}
                  type="button"
                  onClick={() => setSuggestOpen(true)}
                  className="inline-flex items-center gap-2 rounded-md bg-neutral-900 px-4 h-9 text-white hover:bg-neutral-800 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-black/40"
                  aria-label="Open the suggest a set modal"
                  whileHover={{ y: -1, scale: 1.01 }}
                  whileTap={{ y: 0, scale: 0.99 }}
                >
                  <span className="-ml-1"><PaperPlaneOutlineIcon /></span>
                  <span>Suggest a set</span>
                </motion.button>
              </div>
            </div>

            {/* Column labels */}
            <div className={`${ROW_COLS} text-xs font-medium text-neutral-500 px-4 py-1.5 border-b border-neutral-200 hidden sm:grid`}>
              <div className="uppercase tracking-widest">title</div>
              <div className="uppercase tracking-widest text-center">genre</div>
              <div className="uppercase tracking-widest text-center">links</div>
            </div>
          </div>

          {/* Virtualized rows */}
          <div style={{ height: rowVirtualizer.getTotalSize(), position: "relative" }}>
            {rowVirtualizer.getVirtualItems().map(vi => {
              const r = filtered[vi.index];

              return (
                <div
                  key={vi.key}
                  data-index={vi.index}
                  className="absolute left-0 right-0"
                  style={{ transform: `translateY(${vi.start}px)`, height: `${vi.size}px` }}
                >
                  {loading ? (
                    <div className={`${ROW_COLS} px-4 py-3 odd:bg-white animate-pulse hidden sm:grid`}>
                      {Array.from({ length: 3 }).map((_, j) => (
                        <div key={j} className="h-4 w-3/4 bg-neutral-200 rounded" />
                      ))}
                    </div>
                  ) : (
                    <>
                      {/* desktop/tablet row */}
                      <div className={`${ROW_COLS} px-4 py-3 odd:bg-white hover:bg-black/5 transition hidden sm:grid`}>
                        <div className="py-2 min-w-0">
                          <a
                            href={r?.youtube || r?.soundcloud || "#"}
                            className="block truncate hover:underline"
                            title={r?.set}
                          >
                            {r?.set}
                          </a>
                        </div>

                        <div className="py-1 flex justify-center">
                          {(r?.classification || "").trim() ? (
                            <Tag>{(r?.classification || "").toLowerCase()}</Tag>
                          ) : (
                            <div className="h-6" />
                          )}
                        </div>

                        <div className="py-1">
                          <div className="grid grid-cols-2 w-[88px] mx-auto place-items-center">
                            {r?.soundcloud ? (
                              <IconButton
                                title="play on SoundCloud"
                                ariaLabel="play on SoundCloud"
                                onClick={() => play(r, "soundcloud")}
                                variant="inverted"
                              >
                                <SCIcon />
                              </IconButton>
                            ) : (
                              <span className="w-11 h-11" />
                            )}

                            {r?.youtube ? (
                              <IconButton
                                title="play on YouTube"
                                ariaLabel="play on YouTube"
                                onClick={() => play(r, "youtube")}
                                variant="inverted"
                              >
                                <YouTubeIcon />
                              </IconButton>
                            ) : (
                              <span className="w-11 h-11" />
                            )}
                          </div>
                        </div>
                      </div>

                      {/* mobile card */}
                      <article className="sm:hidden border-b border-neutral-200 px-3 pt-3 pb-4">
                        <div className="flex items-start gap-3">
                          <div className="min-w-0 flex-1">
                            <div className="font-medium leading-snug line-clamp-2">{r?.set}</div>
                            {(r?.classification || "").trim() ? (
                              <div className="mt-1">
                                <Tag>{(r?.classification || "").toLowerCase()}</Tag>
                              </div>
                            ) : (
                              <div className="mt-1 h-6" />
                            )}
                          </div>

                          <div className="flex shrink-0 items-center gap-2">
                            {r?.soundcloud && (
                              <IconButton title="Play on SoundCloud" ariaLabel="Play on SoundCloud" onClick={() => play(r, "soundcloud")} variant="inverted">
                                <SCIcon />
                              </IconButton>
                            )}
                            {r?.youtube && (
                              <IconButton title="Play on YouTube" ariaLabel="Play on YouTube" onClick={() => play(r, "youtube")} variant="inverted">
                                <YouTubeIcon />
                              </IconButton>
                            )}
                          </div>
                        </div>
                      </article>
                    </>
                  )}
                </div>
              );
            })}
          </div>
        </div>

        {/* footer removed per request */}
      </div>
      <SuggestModal open={suggestOpen} onClose={() => setSuggestOpen(false)} restoreFocusTo={suggestBtnRef.current} />
    </section>
  );
}
```

## src/app/page.tsx

```text
// src/app/page.tsx
'use client';

import React from 'react';
import { motion } from 'framer-motion';
import { usePlayer } from '@/context/PlayerProvider';

type Row = {
  set: string;
  classification?: string | null;
  youtube?: string | null;
  soundcloud?: string | null;
};

// ytId helper removed (unused)

// ytThumbs helper removed (unused)

// on-demand loader for Random serve (no preload on first paint)
async function fetchSoundcloudPicks(max = 5): Promise<Row[]> {
  const res = await fetch('/api/sheets?tabs=list', { cache: 'no-store' });
  const json = await res.json();
  const rows = (json?.data?.list || []) as Row[];
  const pool = rows.filter(r => r.soundcloud && r.soundcloud.includes('soundcloud.com'));
  // random 5
  return [...pool].sort(() => Math.random() - 0.5).slice(0, max);
}

// Icons are now images in /public/icons

export default function Home() {
  const { play } = usePlayer();
  const [serveItems, setServeItems] = React.useState<Row[]>([]);
  const [serveNonce, setServeNonce] = React.useState(0); // force re-animate
  const [loadingServe, setLoadingServe] = React.useState(false);

  async function loadServe() {
    try {
      setLoadingServe(true);
      const picks = await fetchSoundcloudPicks(5);
      setServeItems(picks);
      setServeNonce(n => n + 1);
    } finally {
      setLoadingServe(false);
    }
  }

  // Heatmaps card removed from landing page

  return (
    <main className="container mx-auto max-w-5xl px-6 pt-4 sm:pt-14">
      {/* generous breathing room under the wordmark */}
      <div className="h-4 sm:h-14" />

      <nav className="grid grid-cols-12 gap-7" role="navigation" aria-label="primary">
        {/* neutralize blue; match card styling used by the others */}
        <a href="/serve" aria-label="Serve up a set. Get served a tailored set"
           className="group relative col-span-12 sm:col-span-6 block rounded-2xl border border-neutral-200/70 bg-white/70 backdrop-blur shadow-[0_10px_30px_rgb(0_0_0_/_0.06)] px-8 py-10 transform-gpu hover:-translate-y-0.5 hover:shadow-[0_18px_40px_rgb(0_0_0_/_0.10)] hover:border-black/30 active:translate-y-0 active:scale-[.99] transition focus-visible:outline-none focus-visible:ring-4 focus-visible:ring-black/20">
          <div className="flex items-start gap-3"><img src="/icons/icon_serve.png" alt="" className="h-9 w-9 opacity-80" /><div><div className="text-lg font-semibold">Serve up a set</div><div className="text-xs font-medium tracking-widest mt-1 opacity-90">Get served a tailored set</div></div></div>
        </a>

        <a href="/list" aria-label="Show the list. Go through all hand-curated grooves"
           className="group relative col-span-12 sm:col-span-6 block rounded-2xl border border-neutral-200/70 bg-white/70 backdrop-blur shadow-[0_10px_30px_rgb(0_0_0_/_0.06)] px-8 py-10 transform-gpu hover:-translate-y-0.5 hover:shadow-[0_18px_40px_rgb(0_0_0_/_0.10)] hover:border-black/30 active:translate-y-0 active:scale-[.99] transition focus-visible:outline-none focus-visible:ring-4 focus-visible:ring-black/20">
          <div className="flex items-start gap-3"><img src="/icons/icon_list.png" alt="" className="h-9 w-9 opacity-80" /><div><div className="text-lg font-semibold text-neutral-900">Show the list</div><div className="text-xs font-medium tracking-widest text-neutral-500 mt-1">Go through all hand-curated grooves</div></div></div>
        </a>

        {/* Heatmaps entry intentionally removed from landing page */}
      </nav>

      {/* call-to-action: centered dice animation button */}
      <div className="mt-10 flex justify-center">
        <button
          onClick={loadServe}
          className="relative inline-flex items-center gap-3 rounded-full border border-neutral-300 bg-white px-5 py-3 text-sm font-semibold shadow-sm hover:shadow-md active:scale-[.99] transition random-serve-dice"
        >
          <span className="dice-wrap" aria-hidden="true">
            <Dice variant="a" />
            <Dice variant="b" />
          </span>
          Random serve
        </button>
      </div>
      <style>{`
        /* Dice toss/roll animation: 5s cycle => 4s idle, 1s roll */
        @keyframes diceTossCycle {
          0%, 79.999% {
            transform: translate(0, 0) rotate(0deg) scale(1);
            filter: drop-shadow(0 0 0 rgba(0,0,0,0));
          }
          /* lift-off + first spin */
          82% {
            transform: translate(calc(var(--x, 0px) * .3), -12px) rotate(var(--rA, 200deg)) scale(1.03);
            filter: drop-shadow(0 10px 14px rgba(0,0,0,.18));
          }
          /* descend with momentum */
          90% {
            transform: translate(var(--x, 0px), 4px) rotate(var(--rB, 410deg)) scale(.985);
            filter: drop-shadow(0 5px 10px rgba(0,0,0,.16));
          }
          /* small bounce */
          96% {
            transform: translate(calc(var(--x, 0px) * .6), -3px) rotate(var(--rC, 520deg)) scale(1.01);
            filter: drop-shadow(0 6px 10px rgba(0,0,0,.12));
          }
          /* settle */
          100% {
            transform: translate(0, 0) rotate(var(--rEnd, 540deg)) scale(1);
            filter: drop-shadow(0 0 0 rgba(0,0,0,0));
          }
        }
        .random-serve-dice .dice-wrap { display: inline-flex; align-items: center; gap: 6px; }
        .random-serve-dice .die {
          /* default motion params for die A */
          --x: -8px;
          --rA: 200deg;
          --rB: 410deg;
          --rC: 520deg;
          --rEnd: 540deg;
          animation: diceTossCycle 5s ease-in-out infinite;
          will-change: transform;
          transform-origin: 55% 48%;
        }
        .random-serve-dice .die-b {
          /* mirrored + slightly faster spin for variety */
          --x: 8px;
          --rA: -220deg;
          --rB: -430deg;
          --rC: -560deg;
          --rEnd: -600deg;
          animation-delay: .04s;
          transform-origin: 45% 52%;
        }
        /* Only display the matching face for each die */
        .random-serve-dice .die .face { display: none; }
        .random-serve-dice .die[data-face='1'] .face-1 { display: block; }
        .random-serve-dice .die[data-face='2'] .face-2 { display: block; }
        .random-serve-dice .die[data-face='3'] .face-3 { display: block; }
        .random-serve-dice .die[data-face='4'] .face-4 { display: block; }
        .random-serve-dice .die[data-face='5'] .face-5 { display: block; }
        .random-serve-dice .die[data-face='6'] .face-6 { display: block; }
        @media (prefers-reduced-motion: reduce) {
          .random-serve-dice .die { animation: none; }
        }
      `}</style>

      {/* extra room above the pentagon tiles; render only after click */}
      <section className="mt-6 min-h-[320px]">
        {serveItems.length === 0 ? (
          loadingServe ? (
            <div className="mt-6 text-center text-sm text-neutral-500">
              {'Summoning grooves…'}
            </div>
          ) : null
        ) : (() => {
          // pick 5 soundcloud rows
          const items = serveItems.slice(0, 5);

          // base regular pentagon vertices (% of container, centered at 50/50)
          const BASE = [
            { left: 50.0,  top: 10.0 },   // top
            { left: 88.04, top: 37.64 },  // upper right
            { left: 73.51, top: 82.36 },  // lower right
            { left: 26.49, top: 82.36 },  // lower left
            { left: 11.96, top: 37.64 },  // upper left
          ];
          // shrink pentagon around center without changing tile size
          const center = { x: 50, y: 50 };
          const SHRINK = 0.82; // 82% radius → smaller pentagon
          const PENTA = BASE.map(p => ({
            left: center.x + (p.left - center.x) * SHRINK,
            top:  center.y + (p.top  - center.y) * SHRINK,
          }));
          const sizePct = 28; // tile size as % of container width (unchanged)

          return (
            <div key={serveNonce} className="relative mx-auto aspect-square w-full max-w-3xl">
              {/* outline removed as requested */}

              {items.map((r, i) => {
                const pos = PENTA[i];
                if (!pos) return null;
                return (
                  <motion.button
                    key={i}
                    aria-label={`Play ${r.set}`}
                    onClick={() => play(r, 'soundcloud')}
                    className="absolute -translate-x-1/2 -translate-y-1/2 rounded-xl overflow-hidden border border-neutral-200/70 bg-white shadow-sm hover:shadow-md hover:border-black/30 transition transform-gpu active:scale-[.99]"
                    style={{
                      left: `${pos.left}%`,
                      top: `${pos.top}%`,
                      width: `${sizePct}%`,
                      height: `${sizePct}%`,
                    }}
                    initial={{ opacity: 0, scale: 0.94, y: 6 }}
                    animate={{ opacity: 1, scale: 1, y: 0 }}
                    transition={{ duration: 0.45, ease: 'easeOut', delay: 0.08 * i }}
                  >
                    <SCArtwork url={r.soundcloud!} />
                  </motion.button>
                );
              })}

              {/* placeholders if fewer than 5 items */}
              {Array.from({ length: Math.max(0, 5 - items.length) }).map((_, j) => {
                const pos = PENTA[items.length + j];
                if (!pos) return null;
                return (
                  <motion.div
                    key={`ph-${j}`}
                    className="absolute -translate-x-1/2 -translate-y-1/2 rounded-xl border border-neutral-200/60 bg-[radial-gradient(circle_at_30%_30%,#e5e7eb,#fafafa)]"
                    style={{
                      left: `${pos.left}%`,
                      top: `${pos.top}%`,
                      width: `${sizePct}%`,
                      height: `${sizePct}%`,
                    }}
                    initial={{ opacity: 0, scale: 0.94, y: 6 }}
                    animate={{ opacity: 1, scale: 1, y: 0 }}
                    transition={{ duration: 0.45, ease: 'easeOut', delay: 0.08 * (items.length + j) }}
                  />
                );
              })}
            </div>
          );
        })()}
      </section>

      <div className="h-14" />
    </main>
  );
}

// CoverBackground component removed (unused)

function Dice({ variant }: { variant: 'a' | 'b' }) {
  const [face, setFace] = React.useState<number>(variant === 'a' ? 1 : 4);
  const onIter = React.useCallback(() => {
    setFace(f => (f % 6) + 1);
  }, []);
  return (
    <svg
      className={`die die-${variant}`}
      viewBox="0 0 24 24"
      width="18"
      height="18"
      fill="none"
      role="img"
      focusable="false"
      onAnimationIteration={onIter}
      data-face={face}
    >
      <rect x="2" y="2" width="20" height="20" rx="5" fill="#111" stroke="#111" strokeWidth="1.5" />
      {/* Faces 1..6; show one at a time via CSS */}
      <g className="face face-1">
        <circle cx="12" cy="12" r="1.7" fill="#fff" />
      </g>
      <g className="face face-2">
        <circle cx="8" cy="8" r="1.7" fill="#fff" />
        <circle cx="16" cy="16" r="1.7" fill="#fff" />
      </g>
      <g className="face face-3">
        <circle cx="8" cy="8" r="1.7" fill="#fff" />
        <circle cx="12" cy="12" r="1.7" fill="#fff" />
        <circle cx="16" cy="16" r="1.7" fill="#fff" />
      </g>
      <g className="face face-4">
        <circle cx="8" cy="8" r="1.7" fill="#fff" />
        <circle cx="16" cy="8" r="1.7" fill="#fff" />
        <circle cx="8" cy="16" r="1.7" fill="#fff" />
        <circle cx="16" cy="16" r="1.7" fill="#fff" />
      </g>
      <g className="face face-5">
        <circle cx="8" cy="8" r="1.7" fill="#fff" />
        <circle cx="16" cy="8" r="1.7" fill="#fff" />
        <circle cx="12" cy="12" r="1.7" fill="#fff" />
        <circle cx="8" cy="16" r="1.7" fill="#fff" />
        <circle cx="16" cy="16" r="1.7" fill="#fff" />
      </g>
      <g className="face face-6">
        <circle cx="8" cy="7.5" r="1.7" fill="#fff" />
        <circle cx="8" cy="12" r="1.7" fill="#fff" />
        <circle cx="8" cy="16.5" r="1.7" fill="#fff" />
        <circle cx="16" cy="7.5" r="1.7" fill="#fff" />
        <circle cx="16" cy="12" r="1.7" fill="#fff" />
        <circle cx="16" cy="16.5" r="1.7" fill="#fff" />
      </g>
    </svg>
  );
}

function SCArtwork({url, preserveRatio=false}:{url:string; preserveRatio?:boolean}) {
  const [art,setArt]=React.useState<string|null>(null);
  const [failed,setFailed]=React.useState(false);
  React.useEffect(()=>{let ok=true;(async()=>{
    try{
      const res=await fetch(`/api/soundcloud-artwork?url=${encodeURIComponent(url)}`,{cache:"no-store"});
      const json=await res.json();
      if(ok) setArt(json?.artwork||null);
    }catch{ if(ok) setArt(null); }
  })(); return ()=>{ok=false};},[url]);
  if(!art||failed){
    // when preserving natural ratio, we need an in-flow placeholder
    if (preserveRatio) {
      return <div className="w-full aspect-square rounded-2xl overflow-hidden bg-gradient-to-br from-orange-200 to-orange-400" />;
    }
    // non-preserve case uses a positioned cover
    return <div className="absolute inset-0 bg-gradient-to-br from-orange-200 to-orange-400"/>;
  }
  // eslint-disable-next-line @next/next/no-img-element
  return <img
    src={art}
    alt=""
    className={
      preserveRatio
        ? "block w-full h-auto"
        : "absolute inset-0 w-full h-full object-cover"
    }
    onError={()=>setFailed(true)}
  />;
}
```

## src/app/serve/page.tsx

```text
// src/app/serve/page.tsx
'use client';

import { useEffect, useMemo, useRef, useState } from 'react';
import type { ReactElement } from 'react';
import { motion, AnimatePresence } from 'framer-motion';
import { PageTitle } from '@/components/ui';
import { YouTubeIcon, SCIcon } from '@/components/icons';
import { useRows } from '@/lib/useRows';
import { usePlayer } from '@/context/PlayerProvider';
import type { Row } from '@/lib/useRows';

type Provider='youtube'|'soundcloud';
type PickItem={row: Row; provider: Provider};

const subhdr="text-[12px] font-medium tracking-wide text-neutral-600 uppercase";

/* youtube utilities */
const ytId=(u?:string|null)=>{if(!u) return null;try{const url=new URL(u);if(url.hostname.includes('youtu.be'))return url.pathname.slice(1);if(url.searchParams.get('v'))return url.searchParams.get('v');const p=url.pathname.split('/');const i=p.indexOf('embed');if(i>=0&&p[i+1])return p[i+1];return null;}catch{return null;}};

/* 16:9 thumbnail component with fallbacks to avoid letterboxing */
function YTThumb({url}:{url?:string|null}) {
  const id=ytId(url);
  const order=id?[
    `https://i.ytimg.com/vi/${id}/maxresdefault.jpg`, // 1280x720 if available
    `https://i.ytimg.com/vi/${id}/hq720.jpg`,         // 1280x720 16:9
    `https://i.ytimg.com/vi/${id}/mqdefault.jpg`,     // 320x180 16:9
    `https://i.ytimg.com/vi/${id}/hqdefault.jpg`,     // 480x360 (fallback)
  ]:[];
  const [idx,setIdx]=useState(0);
  const tried = useRef(0);
  if(!id) return null;
  return (
    // eslint-disable-next-line @next/next/no-img-element
    <img src={order[idx]} alt="" className="absolute inset-0 w-full h-full object-cover block"
      onError={()=>{if(tried.current<order.length-1){tried.current++;setIdx(i=>i+1);}}}/>
  );
}

/* SoundCloud artwork using your existing API route */
function SCArtwork({url, preserveRatio=false}:{url:string | null; preserveRatio?:boolean}) {
  const [art,setArt]=useState<string|null>(null);
  const [failed,setFailed]=useState(false);
  useEffect(()=>{let ok=true;(async()=>{
    try{
      if(!url){ if(ok) setArt(null); return; }
      const res=await fetch(`/api/soundcloud-artwork?url=${encodeURIComponent(url)}`,{cache:"no-store"});
      const json=await res.json();
      if(ok) setArt(json?.artwork||null);
    }catch{ if(ok) setArt(null); }
  })(); return ()=>{ok=false};},[url]);  
  if(!art||failed){
    return <div className="absolute inset-0 bg-gradient-to-br from-orange-200 to-orange-400"/>;
  }
  // eslint-disable-next-line @next/next/no-img-element
  return <img
    src={art}
    alt=""
    className={
      preserveRatio
        ? "block w-full h-auto" // keep native ratio
        : "absolute inset-0 w-full h-full object-cover"
    }
    onError={()=>setFailed(true)}
  />;
}

export default function ServePage(){
  const { rows }=useRows();
  const { play }=usePlayer();
  const endRef = useRef<HTMLDivElement | null>(null);
  const suggestionRef = useRef<HTMLDivElement | null>(null);

  // defaults: Any; format persists
  const [genre,setGenre]=useState<'any'|string>('any');
  const [format,setFormat]=useState<'none'|Provider>('soundcloud');

  useEffect(()=>{try{
    setGenre((localStorage.getItem('ga_genre') ?? 'any') as 'any' | string);
    const f=(localStorage.getItem('ga_format')||'soundcloud').toLowerCase();
    setFormat(f==='youtube'?'youtube':f==='soundcloud'?'soundcloud':'soundcloud');
  }catch{}},[]);
  useEffect(()=>{try{localStorage.setItem('ga_genre',genre);}catch{}},[genre]);
  useEffect(()=>{try{localStorage.setItem('ga_format',format);}catch{}},[format]);

  const genres=useMemo(()=>{const set=new Set(rows.map(r=>(r.classification||'').trim()).filter(Boolean));return [{label:'Any',value:'any' as const},...Array.from(set).sort().map(g=>({label:g,value:g}))];},[rows]);

  const pool=useMemo(()=>rows.filter(r=>{
    if(genre!=='any'&&r.classification!==genre)return false;
    if(format==='youtube')return !!r.youtube;
    if(format==='soundcloud')return !!r.soundcloud;
    return !!(r.youtube||r.soundcloud);
  }),[rows,genre,format]);

  const [pick,setPick]=useState<PickItem|null>(null);
  const [isLaunching,setIsLaunching]=useState(false);
  const [hasLaunched,setHasLaunched]=useState(false);

  // After a suggestion is shown on mobile, scroll it into view (center)
  useEffect(()=>{
    if(!pick) return;
    if (typeof window === 'undefined') return;
    // Use matchMedia for consistency with Tailwind breakpoints
    const isMobile = window.matchMedia('(max-width: 640px)').matches;
    if(!isMobile) return;
    const scrollEl = document.scrollingElement || document.documentElement;
    const centerOnce = () => {
      const el = suggestionRef.current;
      if (!el) return;
      const rect = el.getBoundingClientRect();
      const viewportH = (window.visualViewport?.height ?? window.innerHeight) || window.innerHeight;
      const currentY = window.scrollY || window.pageYOffset || document.documentElement.scrollTop || 0;
      const targetTop = rect.top + currentY - Math.max(0, (viewportH - rect.height) / 2);
      const top = Math.max(0, targetTop);
      try {
        scrollEl.scrollTo({ top, behavior: 'smooth' });
      } catch {
        // Safari fallback without smooth
        (scrollEl as HTMLElement).scrollTop = top;
      }
    };

    // Multiple attempts to account for late image/layout changes on iOS
    const timeouts:number[] = [];
    [120, 360, 720, 1200].forEach(ms => {
      timeouts.push(window.setTimeout(centerOnce, ms));
    });
    return ()=> { timeouts.forEach(id => window.clearTimeout(id)); };
  },[pick]);

  const chooseProviderForRow=(r: Row):Provider=>{
    if(format==='youtube'&&r.youtube)return'youtube';
    if(format==='soundcloud'&&r.soundcloud)return'soundcloud';
    if(r.youtube&&r.soundcloud)return Math.random()<0.5?'youtube':'soundcloud';
    return r.youtube?'youtube':'soundcloud';
  };

  const launch=()=>{
    setIsLaunching(true);
    const chosenRow=[...pool].sort(()=>Math.random()-.5)[0]||null;
    const chosen=chosenRow?{row:chosenRow,provider:chooseProviderForRow(chosenRow)}:null;
    setTimeout(()=>{setPick(chosen);setIsLaunching(false);setHasLaunched(true);},1000);
  };

  const Circle=({selected}:{selected:boolean})=><span className={`inline-block h-3 w-3 rounded-full border ${selected?'bg-black border-black':'border-neutral-400 bg-white'}`}/>;
  const CircleOption=({label,value,icon}:{label:string;value:Provider;icon:ReactElement})=>(
    <motion.button type="button" aria-pressed={format===value} onClick={(e)=>{ e.stopPropagation(); setFormat(f=>f===value?'none':value); }}
      className={`h-10 px-3 rounded-lg border text-sm inline-flex items-center gap-2 ${format===value?'bg-white text-neutral-900 border-neutral-900':'bg-white border-neutral-300 hover:bg-neutral-50'}`}
      whileHover={{ y: -1, scale: 1.01 }}
      whileTap={{ y: 0, scale: 0.99 }}
    >
      <Circle selected={format===value}/>{icon}<span>{label}</span>
    </motion.button>
  );

  const titleOf=(r: Row)=>r?.set||'Untitled set';
  const labelOf=(r: Row)=> (r?.classification||'').trim();  

  return (
    <section className="container mx-auto max-w-6xl px-6 mt-8 space-y-6">
      <PageTitle title="SERVER"/>

      {/* compact controls */}
      <div className="relative z-10 rounded-2xl border border-neutral-200 bg-neutral-50/60 backdrop-blur p-4 shadow-sm max-w-2xl mx-auto">
        <div className="grid sm:grid-cols-2 gap-3">
          {/* Genre left */}
          <div className="p-4 sm:pr-6">
            <div className={subhdr} style={{fontFamily:"'Space Grotesk',system-ui,sans-serif"}}>Genre</div>
            <div className="mt-1.5">
              <select
                className="w-full sm:w-auto min-w-56 h-10 rounded-lg border border-neutral-300 bg-white px-4 text-sm"
                value={genre}
                onChange={(e)=>setGenre(e.target.value)}
              >
                {genres.map(g=> (
                  <option key={g.value} value={g.value}>{g.label}</option>
                ))}
              </select>
            </div>
          </div>
          {/* Format right */}
          <div className="p-4 sm:pl-6">
            <div className={subhdr} style={{fontFamily:"'Space Grotesk',system-ui,sans-serif"}}>Format</div>
            <div className="mt-1.5 flex gap-2 justify-start sm:justify-end">
              <CircleOption label="SoundCloud" value="soundcloud" icon={<SCIcon/>}/>
              <CircleOption label="YouTube" value="youtube" icon={<YouTubeIcon/>}/>
            </div>
          </div>
          {/* Go button row */}
          <div className="p-3 sm:col-span-2 grid place-items-center">
            <motion.button onClick={launch}
              whileHover={{y:-1,scale:1.01,boxShadow:"0 8px 16px rgba(0,0,0,.20)"}}
              whileTap={{y:0,scale:0.99,boxShadow:"0 4px 10px rgba(0,0,0,.15)"}}
              disabled={isLaunching}
              className="mt-0 inline-flex h-11 w-72 rounded-full bg-[var(--accent)] text-white leading-none items-center justify-center select-none disabled:opacity-60 disabled:cursor-not-allowed"
            >
              {hasLaunched?'Go again!':'Go'}
            </motion.button>
          </div>
        </div>
      </div>

      {/* vinyl spin overlay - replaces pulse overlay */}
      <AnimatePresence>
        {isLaunching&&(
          <motion.div
            className="fixed inset-0 z-40 pointer-events-none grid place-items-center"
            initial={{opacity:0}}
            animate={{opacity:1}}
            exit={{opacity:0}}
            style={{background:'radial-gradient(1200px 1200px at 50% 50%, rgba(0,0,0,0.18), transparent 60%)'}}
          >
            <div className="relative">
              <img
                src="/icons/icon_serve.png"
                alt=""
                className="h-40 w-40 sm:h-48 sm:w-48 rounded-full select-none animate-[spin_1s_linear_1] drop-shadow-xl"
                draggable={false}
              />
              <span className="pointer-events-none absolute inset-0 m-auto block h-6 w-6 rounded-full bg-white/90 ring-2 ring-neutral-300" />
            </div>
          </motion.div>
        )}
      </AnimatePresence>

      {/* suggestion */}
      {!isLaunching&&pick&&(
        <div ref={suggestionRef} className="relative z-0 max-w-2xl mx-auto mt-4">
          <motion.article
            whileHover={{ y: -2 }}
            className={
              pick.provider === 'youtube'
                ? '' // remove outer white card to avoid wider box than video
                : 'overflow-visible'
            }
            onClick={() => play(pick.row, pick.provider)}
            role="button"
            aria-label="play suggestion"
          >
            <div
              className={
                "relative mx-auto " +
                (pick.provider === 'youtube'
                  ? "aspect-video w-full sm:w-4/5 md:w-3/4 rounded-2xl overflow-hidden"
                  : "w-full sm:w-4/5 md:w-3/4")
              }
              style={pick.provider === 'soundcloud'
                ? { aspectRatio: 'auto' }
                : undefined
              }
            >
              {pick.provider === 'youtube'
                ? <YTThumb url={pick.row.youtube}/>
                : <SCArtwork url={pick.row.soundcloud} preserveRatio />}
              <div className="absolute inset-0 grid place-items-center pointer-events-none">
                <div className="rounded-full bg-white/90 border border-neutral-300 w-14 h-14 grid place-items-center">
                  {pick.provider==='youtube'?<YouTubeIcon/>:<SCIcon/>}
                </div>
              </div>
            </div>
          </motion.article>

          {/* big title and label (no dot) */}
          <div className="px-1 pt-3 text-center">
            <h3 className="text-2xl font-semibold leading-tight break-words" style={{fontFamily:"'Space Grotesk',system-ui,sans-serif"}}>
              {titleOf(pick.row)}
            </h3>
            {labelOf(pick.row) && (
              <div className="mt-1 text-2xl font-semibold leading-tight" style={{fontFamily:"'Space Grotesk',system-ui,sans-serif"}}>
                {labelOf(pick.row)}
              </div>
            )}
          </div>
        </div>
      )}
      {/* bottom spacer and anchor for scrolling (extra mobile space to avoid phone UI overlap) */}
      <div ref={endRef} className="h-[40px] sm:h-4" />
    </section>
  );
}
```

## src/components/AppShell.tsx

```text
// src/components/AppShell.tsx
'use client';

import { ReactNode } from 'react';
import { useRouter } from 'next/navigation';
import { Fonts, WordmarkHeader } from '@/components/Header';
import CommandBar from '@/components/CommandBar';
import CompactPillPlayer from '@/components/player/CompactPillPlayer';
import PlayerModal from '@/components/PlayerModal';
import ScrollTopFab from '@/components/ScrollTopFab';
import { useRows } from '@/lib/useRows';

type Route = 'home'|'list'|'serve'|'heatmaps'|'suggest';

export default function AppShell({ children }: { children: ReactNode }) {
  const router = useRouter();
  const { rows } = useRows();

  const onNavigate = (r: Route) => router.push(r === 'home' ? '/' : `/${r}`);

  return (
    <>
      <Fonts />
      <WordmarkHeader />
      {children}
      <CommandBar rows={rows} onNavigate={onNavigate} />
      <ScrollTopFab />
      <CompactPillPlayer />
      <PlayerModal />
    </>
  );
}
```

## src/components/CommandBar.tsx

```text
'use client';
import { useEffect, useMemo, useRef, useState } from "react";
import { AnimatePresence, motion } from "framer-motion";
import { usePlayer } from "@/context/PlayerProvider";
import type { Row } from "@/lib/types";
import { SearchIcon } from "@/components/icons";
import { copyToClipboard } from "@/lib/utils";

export default function CommandBar({ rows, onNavigate }: { rows: Row[]; onNavigate: (r: 'home'|'list'|'serve'|'heatmaps'|'suggest') => void }) {
  const [open,setOpen]=useState(false); const [q,setQ]=useState(""); const inputRef=useRef<HTMLInputElement|null>(null); const [sel,setSel]=useState(0);
  const { play, enqueue }=usePlayer();
  useEffect(()=>{const onKey=(e:KeyboardEvent)=>{if(e.key.toLowerCase()==="k"&&!e.metaKey&&!e.ctrlKey&&!e.altKey){e.preventDefault();setOpen(v=>!v);} if(e.key==="Escape") setOpen(false);}; window.addEventListener("keydown",onKey); return()=>window.removeEventListener("keydown",onKey);},[]);
  useEffect(()=>{if(open) setTimeout(()=>inputRef.current?.focus(),0); else{setQ("");setSel(0);}},[open]);
  const filtered=useMemo(()=>{const term=q.toLowerCase().trim(); const base=term?rows.filter(r=>r.set.toLowerCase().includes(term)||(r.classification||"").toLowerCase().includes(term)):rows; return base.slice(0,8);},[q,rows]);
  const onKeyDown=(e:React.KeyboardEvent)=>{if(e.key==="ArrowDown"){setSel(i=>Math.min(i+1,filtered.length-1));e.preventDefault();} if(e.key==="ArrowUp"){setSel(i=>Math.max(i-1,0));e.preventDefault();} if(e.key==="Enter"){const row=filtered[sel]; if(!row) return; if(e.metaKey||e.ctrlKey){const t=row.youtube||row.soundcloud||"#"; window.open(t,"_blank","noopener,noreferrer");} else {play(row); setOpen(false);}}};
  return (<AnimatePresence>{open&&(<motion.div className="fixed inset-0 z-50 bg-black/60 backdrop-blur-sm" initial={{opacity:0}} animate={{opacity:1}} exit={{opacity:0}} onClick={()=>setOpen(false)}><motion.div className="mx-auto mt-24 w-[92vw] max-w-2xl rounded-2xl border border-white/10 bg-[var(--ash)]/60 backdrop-blur-xl overflow-hidden" initial={{y:10,opacity:0}} animate={{y:0,opacity:1}} exit={{y:10,opacity:0}} onClick={e=>e.stopPropagation()}><div className="flex items-center gap-2 px-4 py-3 border-b border-white/10"><SearchIcon/><input ref={inputRef} value={q} onChange={e=>setQ(e.target.value)} onKeyDown={onKeyDown} placeholder="type to search sets or jump to a page" className="w-full bg-transparent outline-none placeholder-white/50"/><kbd className="text-xs bg-white/5 border border-white/10 px-2 py-1 rounded-md">esc</kbd></div><div className="grid grid-cols-1 md:grid-cols-2 divide-y md:divide-y-0 md:divide-x divide-white/10"><div className="max-h-[40vh] overflow-auto"><div className="px-4 py-2 text-xs uppercase tracking-widest opacity-70">pages</div>{[{label:"Home",action:()=>onNavigate("home")},{label:"The list",action:()=>onNavigate("list")},{label:"Serve up a set",action:()=>onNavigate("serve")},{label:"Heatmaps",action:()=>onNavigate("heatmaps")},{label:"Suggest a set",action:()=>onNavigate("suggest")}].map(it=>(<button key={it.label} onClick={()=>{it.action();setOpen(false);}} className="w-full text-left px-4 py-2 hover:bg-white/10">{it.label}</button>))}</div><div className="max-h-[40vh] overflow-auto"><div className="px-4 py-2 text-xs uppercase tracking-widest opacity-70">sets</div>{filtered.map((r,i)=>(<div key={r.set} className={`px-4 py-2 ${i===sel?"bg-white/10":"hover:bg-white/10"}`} onMouseEnter={()=>setSel(i)}><div className="flex items-center justify-between gap-2"><div className="min-w-0"><div className="font-medium truncate">{r.set}</div><div className="text-xs opacity-70 capitalize truncate">{(r.classification||"").toLowerCase()||"unknown"}</div></div><div className="flex items-center gap-2 shrink-0"><button className="btn-secondary" onClick={()=>enqueue(r)}>queue</button><button className="btn-secondary" onClick={()=>copyToClipboard(r.youtube||r.soundcloud||"")}>copy</button><button className="btn-secondary" onClick={()=>{const t=r.youtube||r.soundcloud||"#"; window.open(t,"_blank","noopener,noreferrer");}}>open</button></div></div></div>))}{filtered.length===0&&<div className="px-4 py-3 text-sm opacity-70">no results</div>}</div></div></motion.div></motion.div>)}</AnimatePresence>);
}
```

## src/components/GlobalMenu.tsx

```text
'use client';

import { useEffect, useRef, useState, type ReactNode } from 'react';
import { usePathname, useRouter } from 'next/navigation';
import {
  CloseIcon,
  HeatmapOutlineIcon,
  HomeOutlineIcon,
  ListOutlineIcon,
  MenuIcon,
  PaperPlaneOutlineIcon,
  PlayOutlineIcon,
} from '@/components/icons';
import SuggestModal from '@/components/SuggestModal';

type Item = { label: string; href: string; icon: ReactNode };

// Order: Serve up a set, The list, Heatmaps, Suggest a set, Home
const MENU_ITEMS: Item[] = [
  { label: 'Serve up a set', href: '/serve', icon: <PlayOutlineIcon /> },
  { label: 'The list', href: '/list', icon: <ListOutlineIcon /> },
  { label: 'Heatmaps', href: '/heatmaps', icon: <HeatmapOutlineIcon /> },
  { label: 'Suggest a set', href: '/suggest', icon: <PaperPlaneOutlineIcon /> },
  { label: 'Home', href: '/', icon: <HomeOutlineIcon /> },
];

function useIsDesktop(minWidth = 640) {
  const [isDesktop, setIsDesktop] = useState(false);
  useEffect(() => {
    const mq = window.matchMedia(`(min-width: ${minWidth}px)`);
    const update = () => setIsDesktop(mq.matches);
    update();
    mq.addEventListener?.('change', update);
    return () => mq.removeEventListener?.('change', update);
  }, [minWidth]);
  return isDesktop;
}

export default function GlobalMenu() {
  const [open, setOpen] = useState(false);
  const [suggestOpen, setSuggestOpen] = useState(false);
  const pathname = usePathname() || '/';
  const router = useRouter();
  const isDesktop = useIsDesktop();

  const triggerRef = useRef<HTMLButtonElement | null>(null);
  const popoverRef = useRef<HTMLDivElement | null>(null);
  const sheetRef = useRef<HTMLDivElement | null>(null);
  const closeRef = useRef<HTMLButtonElement | null>(null);
  const itemRefs = useRef<HTMLAnchorElement[]>([]);

  // Reset refs array on each render to current items count
  itemRefs.current = [];

  // active index not used for UI behavior currently; removed to avoid lint noise

  // Close on route change
  useEffect(() => {
    if (open) setOpen(false);
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [pathname]);

  // Outside click to close (popover)
  useEffect(() => {
    if (!open) return;
    const onDown = (e: MouseEvent | PointerEvent) => {
      const t = e.target as Node | null;
      const container = isDesktop ? popoverRef.current : sheetRef.current;
      if (!container) return;
      if (
        t &&
        !container.contains(t) &&
        !triggerRef.current?.contains(t)
      ) {
        setOpen(false);
      }
    };
    window.addEventListener('pointerdown', onDown);
    return () => window.removeEventListener('pointerdown', onDown);
  }, [open, isDesktop]);

  // Esc to close, and basic focus trap handling
  useEffect(() => {
    if (!open) return;
    const onKey = (e: KeyboardEvent) => {
      if (e.key === 'Escape') {
        e.preventDefault();
        setOpen(false);
        setTimeout(() => triggerRef.current?.focus(), 0);
      }
    };
    window.addEventListener('keydown', onKey);
    return () => window.removeEventListener('keydown', onKey);
  }, [open]);

  // When opening, focus the first menu item
  useEffect(() => {
    if (!open) return;
    setTimeout(() => itemRefs.current[0]?.focus(), 0);
  }, [open]);

  // Lock background scroll on mobile overlay
  useEffect(() => {
    if (!open || isDesktop) return;
    const prev = document.body.style.overflow;
    document.body.style.overflow = 'hidden';
    return () => { document.body.style.overflow = prev; };
  }, [open, isDesktop]);

  const handleOpen = () => setOpen(true);
  const handleClose = () => {
    setOpen(false);
    setTimeout(() => triggerRef.current?.focus(), 0);
  };

  const onItemKeyDown = (e: React.KeyboardEvent<HTMLAnchorElement>, idx: number) => {
    if (e.key === 'ArrowDown') {
      e.preventDefault();
      const next = (idx + 1) % itemRefs.current.length;
      itemRefs.current[next]?.focus();
    } else if (e.key === 'ArrowUp') {
      e.preventDefault();
      const prev = (idx - 1 + itemRefs.current.length) % itemRefs.current.length;
      itemRefs.current[prev]?.focus();
    } else if (e.key === 'Tab' && e.shiftKey && idx === 0) {
      // Shift+Tab from first item -> close button
      e.preventDefault();
      closeRef.current?.focus();
    } else if (e.key === 'Tab' && !e.shiftKey && idx === itemRefs.current.length - 1) {
      // Tab from last item -> loop to first
      e.preventDefault();
      itemRefs.current[0]?.focus();
    }
  };

  const onCloseKeyDown = (e: React.KeyboardEvent<HTMLButtonElement>) => {
    if (e.key === 'Tab' && !e.shiftKey) {
      // Tab from close -> first item
      e.preventDefault();
      itemRefs.current[0]?.focus();
    } else if (e.key === 'Tab' && e.shiftKey) {
      // Shift+Tab on close -> last item
      e.preventDefault();
      const last = itemRefs.current.length - 1;
      if (last >= 0) itemRefs.current[last]?.focus();
    }
  };

  const trackNav = (label: string, href: string) => {
    try {
      // Optional Vercel Web Analytics if present on window
      // @ts-expect-error -- optional Vercel Web Analytics global
      if (typeof window !== 'undefined' && window.va && typeof window.va.track === 'function') {
        // @ts-expect-error -- optional Vercel Web Analytics global
        window.va.track('navigation_click', { label, href });
      }
    } catch {}
  };

  const onActivate = (href: string, label: string) => {
    setOpen(false);
    if (href === '/suggest') {
      // Open suggest modal instead of navigating
      setTimeout(() => setSuggestOpen(true), 0);
      return;
    }
    trackNav(label, href);
    router.push(href);
  };

  // Tinted active row, consistent for desktop/mobile
  const commonItemClass = (active: boolean) =>
    `flex items-center gap-3 px-3 min-h-14 rounded-lg focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-black/40 ${
      active ? 'bg-black/10 font-medium' : 'hover:bg-black/5'
    }`;

  return (
    <div className="relative">
      <button
        ref={triggerRef}
        type="button"
        aria-haspopup="menu"
        aria-expanded={open}
        aria-label={open ? 'Close menu' : 'Open menu'}
        onClick={() => (open ? handleClose() : handleOpen())}
        className="h-10 w-10 inline-flex items-center justify-center rounded-full hover:bg-black/5 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-black/40"
      >
        <MenuIcon />
      </button>

      {open && isDesktop && (
        <div
          ref={popoverRef}
          role="menu"
          aria-label="Global navigation"
          className="absolute right-0 top-full mt-2 w-64 z-50 rounded-xl border border-black/10 bg-white shadow-lg shadow-black/10 motion-reduce:transition-none transition-transform transition-opacity duration-200 ease-out"
        >
          <div className="relative p-2">
            <button
              ref={closeRef}
              type="button"
              aria-label="Close menu"
              onClick={handleClose}
              onKeyDown={onCloseKeyDown}
              className="absolute right-2 top-2 inline-flex h-8 w-8 items-center justify-center rounded-md hover:bg-black/5 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-black/40"
            >
              <CloseIcon />
            </button>
            <nav className="flex flex-col gap-1 pt-8" aria-label="Main">
              {MENU_ITEMS.map((it, i) => {
                const active = it.href === '/' ? pathname === '/' : pathname.startsWith(it.href);
                return (
                  <a
                    key={it.href}
                    ref={(el) => {
                      if (el) itemRefs.current[i] = el;
                    }}
                    href={it.href}
                    aria-current={active ? 'page' : undefined}
                    role="menuitem"
                    onClick={(e) => {
                      e.preventDefault();
                      onActivate(it.href, it.label);
                    }}
                    onKeyDown={(e) => onItemKeyDown(e, i)}
                    className={commonItemClass(active)}
                  >
                    <span className="shrink-0 text-black/80">{it.icon}</span>
                    <span className="truncate">{it.label}</span>
                  </a>
                );
              })}
            </nav>
          </div>
        </div>
      )}

      {open && !isDesktop && (
        <div
          ref={sheetRef}
          className="fixed inset-0 z-50 bg-white"
          role="dialog"
          aria-modal="true"
          aria-label="Global navigation"
        >
          {/* Top bar: close in the same place as the hamburger (right aligned) */}
          <div className="h-14 flex items-center justify-end border-b border-black/10 px-4">
            <button
              ref={closeRef}
              type="button"
              aria-label="Close menu"
              onClick={handleClose}
              onKeyDown={onCloseKeyDown}
              className="inline-flex h-10 w-10 items-center justify-center rounded-md hover:bg-black/5 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-black/40"
            >
              <CloseIcon />
            </button>
          </div>
          <nav className="flex flex-col gap-1 p-3 pb-4" aria-label="Main">
            {MENU_ITEMS.map((it, i) => {
              const active = it.href === '/' ? pathname === '/' : pathname.startsWith(it.href);
              return (
                <a
                  key={it.href}
                  ref={(el) => { if (el) itemRefs.current[i] = el; }}
                  href={it.href}
                  role="menuitem"
                  aria-current={active ? 'page' : undefined}
                  onClick={(e) => { e.preventDefault(); onActivate(it.href, it.label); }}
                  onKeyDown={(e) => onItemKeyDown(e, i)}
                  className={commonItemClass(active)}
                >
                  <span className="shrink-0 text-black/80">{it.icon}</span>
                  <span className="truncate">{it.label}</span>
                </a>
              );
            })}
          </nav>
        </div>
      )}
      <SuggestModal open={suggestOpen} onClose={() => setSuggestOpen(false)} restoreFocusTo={triggerRef.current} />
    </div>
  );
}
```

## src/components/Header.tsx

```text
// src/components/Header.tsx
'use client';
import Link from 'next/link';
import GlobalMenu from '@/components/GlobalMenu';

export function Fonts() {
  return (
    <>
      <link rel="preconnect" href="https://fonts.googleapis.com"/>
      <link rel="preconnect" href="https://fonts.gstatic.com" crossOrigin=""/>
      <link rel="preconnect" href="https://i.ytimg.com"/>{/* speed up thumbs */}
      <link rel="preconnect" href="https://i1.sndcdn.com"/>{/* speed up SC thumbs */}
      <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;600;700;900&display=swap" rel="stylesheet"/>
    </>
  );
}

export function WordmarkHeader() {
  return (
    <header className="pt-8">
      {/* Removed pulsating blue background/animation behind wordmark */}

      <div className="container mx-auto max-w-6xl px-6 relative">
        {/* Global menu trigger */}
        {/* Nudge in a bit on mobile so it doesn't hug the edge */}
        <div className="absolute right-2 sm:right-0 top-0 mt-2 sm:mt-0">
          <GlobalMenu />
        </div>
        <div className="text-center">
          <Link href="/" className="wmk cursor-pointer select-none" aria-label="Go to home">
            <span className="text-2xl sm:text-3xl font-semibold tracking-[0.25em] inline-block" style={{fontFamily:"'Space Grotesk',system-ui,sans-serif"}}>
              THE GROOVE ARCHIVE
            </span>
          </Link>
        </div>
        <div className="mt-4 h-px bg-gradient-to-r from-transparent via-black/30 to-transparent"/>
      </div>
    </header>
  );
}
```

## src/components/icons.tsx

```text
'use client';
// Small inline icon set with outline style where appropriate
export const SearchIcon = () => (
  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" aria-hidden>
    <circle cx="11" cy="11" r="7" stroke="currentColor" strokeWidth="2" />
    <path d="M20 20l-3.5-3.5" stroke="currentColor" strokeWidth="2" />
  </svg>
);

export const PlayIcon = () => (
  <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor" aria-hidden>
    <path d="M8 5v14l11-7z" />
  </svg>
);

export const PlayOutlineIcon = () => (
  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden>
    <path d="M8 5v14l11-7z" stroke="currentColor" strokeWidth="2" fill="none" />
  </svg>
);

export const ArrowUpIcon = () => (
  <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" aria-hidden>
    <path d="M12 5l7 7h-4v7H9v-7H5z" />
  </svg>
);

export const YouTubeIcon = () => (
  <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor" aria-hidden>
    <path d="M23.5 6.2s-.2-1.6-.8-2.3c-.7-.8-1.5-.8-1.9-.9C17.8 2.6 12 2.6 12 2.6s-5.8 0-8.7.4c-.4 0-1.2.1-1.9.9C.7 4.6.5 6.2.5 6.2S0 8.1 0 10v1.9c0 1.9.5 3.8.5 3.8s.2 1.6.8 2.3c.7.8 1.7.7 2.2.8 1.6.2 6.5.4 8.5.4s6.9-.1 8.5-.4c.5-.1 1.5 0 2.2-.8.6-.7.8-2.3.8-2.3S24 13.8 24 11.9V10c0-1.9-.5-3.8-.5-3.8zM9.6 14.6V7.9l6.3 3.4-6.3 3.3z" />
  </svg>
);

export const SCIcon = ({ className }: { className?: string }) => (
  <svg className={className} width="18" height="18" viewBox="0 0 24 24" fill="currentColor" aria-hidden>
    <path d="M17.7 10.1c-.4 0-.8.1-1.2.2-.6-2.4-2.7-4.2-5.3-4.2-1 0-1.9.3-2.7.7-.3.1-.4.4-.4.7v8c0 .4.3.7.7.7h8.9c2 0 3.7-1.6 3.7-3.7 0-2-1.7-3.4-3.7-3.4zM3.5 8.2c-.4 0-.7.3-.7.7v7c0 .4.3.7.7.7s.7-.3.7-.7v-7c0-.4-.3-.7-.7-.7zm2 1.4c-.4 0-.7.3-.7.7v5.6c0 .4.3.7.7.7s.7-.3.7-.7V10.3c0-.4-.3-.7-.7-.7zm2 1.2c-.4 0-.7.3-.7.7v4.4c0 .4.3.7.7.7s.7-.3.7-.7v-4.4c0-.4-.3-.7-.7-.7z" />
  </svg>
);

export const MenuIcon = () => (
  <svg width="24" height="24" viewBox="0 0 24 24" fill="none" aria-hidden>
    <path d="M3 6h18M3 12h18M3 18h18" stroke="currentColor" strokeWidth="2" strokeLinecap="round" />
  </svg>
);

export const CloseIcon = () => (
  <svg width="24" height="24" viewBox="0 0 24 24" fill="none" aria-hidden>
    <path d="M6 6l12 12M18 6l-12 12" stroke="currentColor" strokeWidth="2" strokeLinecap="round" />
  </svg>
);

export const HomeOutlineIcon = () => (
  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden>
    <path d="M3 10.5l9-7 9 7V20a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-9.5z" stroke="currentColor" strokeWidth="2" strokeLinejoin="round" />
  </svg>
);

export const ListOutlineIcon = () => (
  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden>
    <path d="M8 6h13M3 6h1M8 12h13M3 12h1M8 18h13M3 18h1" stroke="currentColor" strokeWidth="2" strokeLinecap="round" />
  </svg>
);

export const HeatmapOutlineIcon = () => (
  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden>
    <rect x="3" y="3" width="7" height="7" rx="1.5" stroke="currentColor" strokeWidth="2" />
    <rect x="14" y="3" width="7" height="7" rx="1.5" stroke="currentColor" strokeWidth="2" />
    <rect x="3" y="14" width="7" height="7" rx="1.5" stroke="currentColor" strokeWidth="2" />
    <rect x="14" y="14" width="7" height="7" rx="1.5" stroke="currentColor" strokeWidth="2" />
  </svg>
);

export const PaperPlaneOutlineIcon = () => (
  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden>
    <path d="M21 3L3 10l8 3 3 8 7-18z" stroke="currentColor" strokeWidth="2" strokeLinejoin="round" fill="none" />
  </svg>
);
```

## src/components/NowPlayingBar.tsx

```text
'use client';
import { usePlayer } from "@/context/PlayerProvider";
import { PlayIcon } from "@/components/icons";

export default function NowPlayingBar(){
  const { current, playing, toggle, next, queue, setOpen }=usePlayer(); if(!current) return null;
  return (<div className="fixed bottom-0 left-0 right-0 z-40 px-3 md:px-6 pb-3"><div className="mx-auto max-w-4xl rounded-2xl border border-white/10 bg-white/5 backdrop-blur-md"><div className="flex items-center gap-3 px-3 py-2">
    <button className="w-11 h-11 rounded-full bg-[var(--sodium)]/20 border border-[var(--sodium)]/60 grid place-items-center" onClick={toggle} aria-label="toggle play">{playing?(<svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M6 5h4v14H6zM14 5h4v14h-4z"/></svg>):(<PlayIcon/>)}</button>
    <div className="flex-1 min-w-0"><div className="truncate text-sm font-semibold">{current.row.set}</div><div className="text-xs opacity-70 capitalize">{(current.row.classification||"").toLowerCase()}</div></div>
    <div className="flex items-center gap-2"><span className="text-xs opacity-70">{current.provider}</span><button className="btn-secondary" onClick={()=>setOpen(true)}>open</button><button className="btn-secondary" onClick={next} disabled={queue.length===0}>next</button></div>
  </div></div></div>);
}
```

## src/components/player/CompactPillPlayer.tsx

```text
'use client';

import { useEffect, useRef } from 'react';
import type { SVGProps } from 'react';
import { usePlayer } from '@/context/PlayerProvider';

// Tiny inline icons to avoid new deps
const Play = (props: SVGProps<SVGSVGElement>) => (
  <svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor" aria-hidden {...props}>
    <path d="M8 5v14l11-7z" />
  </svg>
);
const Pause = (props: SVGProps<SVGSVGElement>) => (
  <svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor" aria-hidden {...props}>
    <path d="M6 5h4v14H6zM14 5h4v14h-4z" />
  </svg>
);
const ExternalLink = (props: SVGProps<SVGSVGElement>) => (
  <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" strokeWidth="2" aria-hidden {...props}>
    <path d="M14 3h7v7" />
    <path d="M10 14L21 3" />
    <path d="M21 14v7H3V3h7" />
  </svg>
);

function ProgressBar({ value }: { value: number }) {
  return (
    <div className="w-full h-[3px] rounded-full bg-white/15 overflow-hidden">
      <div
        className="h-full bg-white/80 transition-[width] duration-200"
        style={{ width: `${Math.max(0, Math.min(100, value))}%` }}
      />
    </div>
  );
}

function fmtTime(sec: number) {
  const s = Math.max(0, Math.floor(sec));
  const m = Math.floor(s / 60);
  const r = s % 60;
  return `${m}:${r.toString().padStart(2, '0')}`;
}

export default function CompactPillPlayer() {
  const { current, playing, toggle, progress, setOpen, durationSec } = usePlayer();
  
  // Keyboard: space toggles when hovering or focusing the pill
  const wrapRef = useRef<HTMLDivElement>(null);
  useEffect(() => {
    const el = wrapRef.current;
    if (!el) return;

    const onKey = (e: KeyboardEvent) => {
      if (e.code === 'Space' || e.key === ' ') {
        e.preventDefault();
        toggle();
      }
    };

    // Focus handling
    el.addEventListener('keydown', onKey);

    // Hover handling
    const enter = () => window.addEventListener('keydown', onKey);
    const leave = () => window.removeEventListener('keydown', onKey);
    el.addEventListener('pointerenter', enter);
    el.addEventListener('pointerleave', leave);

    return () => {
      el.removeEventListener('keydown', onKey);
      el.removeEventListener('pointerenter', enter);
      el.removeEventListener('pointerleave', leave);
      window.removeEventListener('keydown', onKey);
    };
  // Stable deps: only rebind on playing change; toggle is stable from context
  // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [playing]);

  // Guard: render nothing if no track (hooks above remain stable)
  if (!current) return null;

  // Map current track to UI fields
  const title = current.row.set;

  // Map provider progress [0..1] -> percent for micro bar
  const pct = Math.max(0, Math.min(100, (progress ?? 0) * 100));
  // Timecode next to micro bar (elapsed / total) based on provider's durationSec
  const total = durationSec || 30*60; // fallback safety
  const elapsedSec = Math.min(total, Math.floor((progress ?? 0) * total));

  return (
    <div
      // Sticky, safe-area aware
      className={
        'pointer-events-auto fixed inset-x-0 bottom-0 z-40 ' +
        'px-3 pb-[calc(env(safe-area-inset-bottom,0px)+8px)]'
      }
      aria-live="polite"
    >
      <div
        ref={wrapRef}
        tabIndex={0}
        className={
          'mx-auto max-w-2xl ' +
          'rounded-full bg-neutral-900 text-white shadow-2xl ring-1 ring-black/10 ' +
          'px-4 py-2 ' +
          'outline-none focus-visible:ring-2 focus-visible:ring-white/60'
        }
      >
        <div className="flex items-center gap-3">
          {/* Play / Pause */}
          <button
            aria-label={playing ? 'Pause' : 'Play'}
            onClick={toggle}
            className="grid place-items-center rounded-full bg-white text-neutral-900 w-8 h-8 active:scale-95 shadow ring-1 ring-black/10"
          >
            {playing ? <Pause className="h-4 w-4" /> : <Play className="h-4 w-4" />}
          </button>

          {/* Title + micro progress */}
          <div className="min-w-0 flex-1">
            <p className="truncate text-sm font-semibold tracking-tight">{title}</p>
            <div className="mt-0.5 flex items-center gap-2">
              <div className="flex-1">
                <ProgressBar value={pct} />
              </div>
              <span className="text-[11px] text-neutral-300 tabular-nums">{fmtTime(elapsedSec)} / {fmtTime(total)}</span>
            </div>
          </div>

          {/* Open big player modal (no external popout) */}
          <button
            type="button"
            onClick={() => { if(!playing) toggle(); setOpen(true); }}
            className="inline-flex items-center gap-1.5 rounded-full bg-white text-neutral-900 px-2.5 py-1 text-xs font-medium shadow ring-1 ring-black/10 hover:bg-neutral-50"
            aria-label="Open player"
            title="Open player"
          >
            open
            <ExternalLink className="h-4 w-4 opacity-80" />
          </button>
        </div>
      </div>
    </div>
  );
}
```

## src/components/PlayerModal.tsx

```text
'use client';
import { useCallback, useEffect, useMemo, useRef, useState } from 'react';
import { usePlayer } from "@/context/PlayerProvider";
import { ytid } from "@/lib/utils";

// Minimal typings for the YouTube IFrame API and SoundCloud Widget API
type YTOnStateChangeEvent = { data?: number };
type YTPlayer = {
  playVideo: () => void;
  pauseVideo: () => void;
  seekTo: (seconds: number, allowSeekAhead?: boolean) => void;
  getCurrentTime?: () => number;
  getDuration?: () => number;
  loadVideoById: (id: string) => void;
  destroy?: () => void;
};
type YTPlayerConfig = {
  videoId: string;
  playerVars?: Record<string, unknown>;
  events?: {
    onReady?: () => void;
    onStateChange?: (e: YTOnStateChangeEvent) => void;
  };
};
type SCWidget = {
  play: () => void;
  pause: () => void;
  seekTo: (ms: number) => void;
  load: (url: string, options?: Record<string, unknown>) => void;
  bind: (event: string, listener: (e?: unknown) => void) => void;
  unbind: (event: string, listener: (e?: unknown) => void) => void;
  getDuration: (cb: (ms: number) => void) => void;
};

declare global {
  interface Window {
    YT?: { Player: new (el: HTMLElement, config: YTPlayerConfig) => YTPlayer };
    SC?: { Widget: ((iframe: HTMLIFrameElement) => SCWidget) & { Events: { PLAY: string; PAUSE: string; PLAY_PROGRESS: string } } };
  }
}

// --- Lightweight script loader that waits until `check()` is true
function loadScriptOnce(src:string, check:()=>boolean):Promise<void>{
  if (typeof window === 'undefined') return Promise.resolve();
  if (check()) return Promise.resolve();
  return new Promise((resolve, reject)=>{
    const tryResolve=()=>{ if(check()){ resolve(); return true; } return false; };
    if (tryResolve()) return;
    const existing=[...document.getElementsByTagName('script')].some(s=>s.src===src);
    const startPolling=()=>{
      const t=setInterval(()=>{ if(check()){ clearInterval(t); resolve(); } },50);
    };
    if(existing){ startPolling(); return; }
    const s=document.createElement('script'); s.src=src; s.async=true;
    s.onload=()=>startPolling();
    s.onerror=()=>reject(new Error('Script load failed: '+src));
    document.head.appendChild(s);
  });
}

// --- YouTube Embed with IFrame API
function YouTubeEmbed({ url }: { url: string }){
  const containerRef = useRef<HTMLDivElement>(null);
  const playerRef = useRef<YTPlayer|null>(null);
  const pollRef = useRef<ReturnType<typeof setInterval>|undefined>(undefined);
  const { registerController, setProgressAbs, setPlayingState } = usePlayer();
  const id = ytid(url) || '';

  // Initialize once
  useEffect(() => {
    let alive = true;
    const init = async () => {
      await loadScriptOnce('https://www.youtube.com/iframe_api', () => typeof window !== 'undefined' && !!window.YT?.Player);
      if (!alive || !containerRef.current) return;
      const YT = window.YT!;
      const origin = typeof window !== 'undefined' ? window.location.origin : '';
      playerRef.current = new YT.Player(containerRef.current, {
        videoId: id,
        playerVars: { autoplay: 1, rel: 0, modestbranding: 1, origin },
        events: {
          onReady: () => {
            // Bridge controls once
            registerController({
              play: () => playerRef.current?.playVideo(),
              pause: () => playerRef.current?.pauseVideo(),
              seek: (seconds: number) => playerRef.current?.seekTo(seconds, true)
            });
            // Start polling once
            if (!pollRef.current) {
              pollRef.current = setInterval(() => {
                try{
                  const cur = playerRef.current?.getCurrentTime?.() || 0;
                  const dur = playerRef.current?.getDuration?.() || 0;
                  if (dur > 0) setProgressAbs(cur, dur);
                }catch{}
              }, 250);
            }
          },
          onStateChange: (e: YTOnStateChangeEvent) => {
            const st = e?.data; // -1,0,1,2,3,5
            if (st === 1) setPlayingState(true); // playing
            else if (st === 2 || st === 0) setPlayingState(false); // paused or ended
          }
        }
      });
    };
    init();
    return () => {
      alive = false;
      if (pollRef.current) { clearInterval(pollRef.current); pollRef.current = undefined; }
      try { registerController(null); playerRef.current?.destroy?.(); } catch {}
    };
  // eslint-disable-next-line react-hooks/exhaustive-deps
  }, []);

  // Load new video on URL change without recreating player
  useEffect(() => {
    const p = playerRef.current;
    if (p && id) {
      try { p.loadVideoById(id); p.playVideo(); } catch {}
    }
  }, [id]);

  return <div ref={containerRef} className="w-full h-full" />;
}

// --- SoundCloud Embed with Widget API
function SoundCloudEmbed({ url }: { url: string }){
  const iframeRef = useRef<HTMLIFrameElement>(null);
  const widgetRef = useRef<SCWidget|null>(null);
  const durationMsRef = useRef<number>(0);
  const lastPosMsRef = useRef<number>(0);
  const durationPollRef = useRef<ReturnType<typeof setInterval>|undefined>(undefined);
  const { registerController, setProgressAbs, setPlayingState } = usePlayer();

  const onPlay = useCallback(() => setPlayingState(true), [setPlayingState]);
  const onPause = useCallback(() => setPlayingState(false), [setPlayingState]);
  const onProgress = useCallback((e: { currentPosition?: number }) => {
    const curMs = e?.currentPosition || 0;
    lastPosMsRef.current = curMs;
    const totalMs = durationMsRef.current;
    if (totalMs > 0) setProgressAbs(curMs / 1000, totalMs / 1000);
  }, [setProgressAbs]);

  // Poll duration until available
  const startDurationPoll = useCallback(() => {
    const w = widgetRef.current;
    if (!w) return;
    if (durationPollRef.current) { clearInterval(durationPollRef.current); durationPollRef.current = undefined; }
    durationMsRef.current = 0;
    durationPollRef.current = setInterval(() => {
      try {
        w.getDuration((ms: number) => {
          if (ms && ms > 0) {
            durationMsRef.current = ms;
            // Update once immediately with last known position
            const cur = lastPosMsRef.current || 0;
            setProgressAbs(cur / 1000, ms / 1000);
            clearInterval(durationPollRef.current);
            durationPollRef.current = undefined;
          }
        });
      } catch {}
    }, 250);
  }, [setProgressAbs]);

  // Initialize once
  useEffect(() => {
    let alive = true;
    const init = async () => {
      await loadScriptOnce('https://w.soundcloud.com/player/api.js', () => typeof window !== 'undefined' && !!window.SC?.Widget);
      if (!alive || !iframeRef.current) return;
      // Minimal base src so the widget can attach
      iframeRef.current.src = `https://w.soundcloud.com/player/?url=`;
      const SC = window.SC!;
      const widget = SC.Widget(iframeRef.current);
      widgetRef.current = widget;
      // Controller once
      registerController({
        play: () => widget?.play(),
        pause: () => widget?.pause(),
        seek: (seconds: number) => widget?.seekTo(seconds * 1000)
      });
      // Bind events once
      widget.bind(SC.Widget.Events.PLAY, onPlay);
      widget.bind(SC.Widget.Events.PAUSE, onPause);
      widget.bind(SC.Widget.Events.PLAY_PROGRESS, onProgress);
      // Load initial URL
      try {
        widget.load(url, { auto_play: true, hide_related: true, show_comments: false, show_user: false, show_reposts: false, visual: true });
        // Begin polling duration until it becomes available
        startDurationPoll();
      } catch {}
    };
    init();
    return () => {
      alive = false;
      const w = widgetRef.current;
      try {
        const SC = window.SC!;
        if (w && SC?.Widget?.Events) {
          w.unbind(SC.Widget.Events.PLAY, onPlay);
          w.unbind(SC.Widget.Events.PAUSE, onPause);
          w.unbind(SC.Widget.Events.PLAY_PROGRESS, onProgress);
        }
        if (durationPollRef.current) { clearInterval(durationPollRef.current); durationPollRef.current = undefined; }
        registerController(null);
      } catch {}
    };
  // eslint-disable-next-line react-hooks/exhaustive-deps
  }, []);

  // Load new track on URL change
  useEffect(() => {
    const w = widgetRef.current;
    if (w && url) {
      try {
        // Reset known duration and start polling again
        durationMsRef.current = 0;
        w.load(url, { auto_play: true, hide_related: true, show_comments: false, show_user: false, show_reposts: false, visual: true });
        startDurationPoll();
      } catch {}
    }
  }, [url, startDurationPoll]);

  return <iframe ref={iframeRef} title="SoundCloud player" className="w-full h-full" allow="autoplay; encrypted-media" />;
}

export default function PlayerModal(){
  const { current, open, setOpen }=usePlayer();

  // Persist the iframe after first open to avoid resetting playback time
  const [mounted, setMounted] = useState(false);
  useEffect(()=>{ if(open) setMounted(true); },[open]);

  // Show/hide with CSS so component remains mounted
  const overlayClasses = useMemo(()=>[
    'fixed inset-0 z-50 grid place-items-center p-4',
    'transition-opacity duration-200',
    open ? 'opacity-100 pointer-events-auto bg-black/75 backdrop-blur-sm' : 'opacity-0 pointer-events-none bg-black/75 backdrop-blur-sm'
  ].join(' '),[open]);

  const onBackdrop = useCallback(()=> setOpen(false), [setOpen]);

  return (
    <div className={overlayClasses} aria-hidden={!open} onClick={onBackdrop}>
      <div className="relative w-full max-w-4xl aspect-video bg-black rounded-xl overflow-hidden border border-white/10 shadow-2xl" onClick={e=>e.stopPropagation()}>
        {/* Minimize button */}
        <div className="absolute top-2 right-2 z-10">
          <button
            type="button"
            onClick={()=>setOpen(false)}
            className="inline-flex items-center gap-1.5 rounded-full bg-white/90 text-neutral-900 px-3 py-1 text-sm font-medium shadow ring-1 ring-black/10 hover:bg-white"
            aria-label="Minimize player"
            title="Minimize"
          >
            minimize
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" aria-hidden>
              <path d="M5 12h14" />
            </svg>
          </button>
        </div>
        {mounted && current && (current.provider==="youtube"?
          <YouTubeEmbed key="youtube" url={current.row.youtube!}/>
          : <SoundCloudEmbed key="soundcloud" url={current.row.soundcloud!}/>
        )}
      </div>
    </div>
  );
}
```

## src/components/ScrollTopFab.tsx

```text
// src/components/ScrollTopFab.tsx
'use client';

import { useEffect, useState } from 'react';
import { motion } from 'framer-motion';
import { ArrowUpIcon } from '@/components/icons';

export default function ScrollTopFab() {
  const [show, setShow] = useState(false);
  useEffect(() => {
    const onScroll = () => setShow(window.scrollY > 600);
    window.addEventListener('scroll', onScroll);
    return () => window.removeEventListener('scroll', onScroll);
  }, []);
  if (!show) return null;
  return (
    <motion.button
      onClick={() => window.scrollTo({ top: 0, behavior: 'smooth' })}
      className="fixed bottom-6 left-6 z-40 p-3 rounded-full bg-white/5 border border-white/10 hover:bg-white/10"
      initial={{ opacity: 0, y: 8 }}
      animate={{ opacity: 1, y: 0 }}
      aria-label="scroll to top"
    >
      <ArrowUpIcon />
    </motion.button>
  );
}
```

## src/components/SuggestModal.tsx

```text
'use client';

import { useEffect, useMemo, useRef } from 'react';
import { motion } from 'framer-motion';

const SUGGEST_TO = 'tga.suggestions@gmail.com';
const SUGGEST_SUBJECT = 'Set suggestion for The Groove Archive';
const SUGGEST_BODY = `Hi Joost,

Link to set:
Optional note:
My email (optional):

Thanks!`;

function buildMailto(to: string, subject: string, body: string) {
  const q = new URLSearchParams({ subject, body }).toString();
  return `mailto:${to}?${q}`;
}

function buildGmail(to: string, subject: string, body: string) {
  const params = new URLSearchParams({ to, su: subject, body });
  return `https://mail.google.com/mail/?view=cm&${params.toString()}`;
}

function track(event: string) {
  try { (window as unknown as { plausible?: (e: string) => void }).plausible?.(event); } catch {}
  try {
    const w = window as unknown as { va?: { track?: (name: string, props?: Record<string, unknown>) => void } };
    if (typeof window !== 'undefined' && w.va && typeof w.va.track === 'function') {
      w.va.track(event);
    }
  } catch {}
}

export default function SuggestModal({ open, onClose, restoreFocusTo }: { open: boolean; onClose: () => void; restoreFocusTo?: HTMLElement | null; }) {
  const dialogRef = useRef<HTMLDivElement | null>(null);

  const mailtoHref = useMemo(() => buildMailto(SUGGEST_TO, SUGGEST_SUBJECT, SUGGEST_BODY), []);
  const gmailHref = useMemo(() => buildGmail(SUGGEST_TO, SUGGEST_SUBJECT, SUGGEST_BODY), []);

  // focus trap + esc close, and restore focus to trigger
  useEffect(() => {
    if (!open) return;
    const dialog = dialogRef.current;
    const prev = (document.activeElement as HTMLElement | null) || restoreFocusTo || null;
    const focusables = () => Array.from(dialog?.querySelectorAll<HTMLElement>(
      'a[href], button, [tabindex]:not([tabindex="-1"])'
    ) || []).filter(el => !el.hasAttribute('disabled'));
    const first = () => focusables()[0];
    const last = () => focusables()[focusables().length - 1];
    const onKey = (e: KeyboardEvent) => {
      if (e.key === 'Escape') { e.preventDefault(); onClose(); }
      if (e.key === 'Tab') {
        const f = focusables(); if (!f.length) return;
        const current = document.activeElement as HTMLElement | null;
        if (e.shiftKey) {
          if (current === f[0] || !dialog?.contains(current)) { e.preventDefault(); last()?.focus(); }
        } else {
          if (current === f[f.length - 1] || !dialog?.contains(current)) { e.preventDefault(); first()?.focus(); }
        }
      }
    };
    document.addEventListener('keydown', onKey);
    // initial focus
    setTimeout(() => first()?.focus(), 0);
    // analytics
    track('suggest_open_modal');
    return () => {
      document.removeEventListener('keydown', onKey);
      // restore focus
      setTimeout(() => prev?.focus?.(), 0);
    };
  }, [open, onClose, restoreFocusTo]);

  if (!open) return null;
  return (
    <div className="fixed inset-0 z-50">
      <div className="absolute inset-0 bg-black/50" onClick={onClose} aria-hidden />
      <div
        ref={dialogRef}
        role="dialog" aria-modal="true" aria-labelledby="suggest-title" aria-describedby="suggest-desc"
        className="absolute inset-x-0 top-6 mx-auto w-[min(640px,92vw)] rounded-xl border border-neutral-200 bg-white p-4 shadow-2xl"
        onClick={e => e.stopPropagation()}
      >
        <div className="mb-3">
          <h2 id="suggest-title" className="text-lg font-semibold tracking-wide text-neutral-900">Send a suggestion</h2>
          <p id="suggest-desc" className="mt-1 text-sm text-neutral-700">
            Paste the link to the set. You can add a short note and your email if you want a reply.
          </p>
        </div>

        <div className="flex flex-col gap-2 sm:flex-row sm:items-center">
          <motion.a
            href={mailtoHref}
            onClick={() => { track('suggest_click_mailto'); }}
            className="inline-flex items-center justify-center rounded-md bg-neutral-900 px-4 py-2 text-white hover:bg-neutral-800 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-black/40 w-full sm:w-auto"
            aria-label="Open your email app to send a suggestion"
            whileHover={{ y: -1, scale: 1.01 }} whileTap={{ y: 0, scale: 0.99 }}
          >
            Mail
          </motion.a>
          <motion.a
            href={gmailHref}
            target="_blank" rel="noopener noreferrer"
            onClick={() => { track('suggest_click_gmail'); }}
            className="inline-flex items-center justify-center rounded-md border border-neutral-300 bg-white px-4 py-2 text-neutral-900 hover:bg-black/5 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-black/40 w-full sm:w-auto"
            aria-label="Open Gmail to send a suggestion"
            whileHover={{ y: -1, scale: 1.01 }} whileTap={{ y: 0, scale: 0.99 }}
          >
            Open in Gmail
          </motion.a>
        </div>
      </div>
    </div>
  );
}
```

## src/components/Thumb.tsx

```text
'use client';
import { useState } from "react";
import type { Row } from "@/lib/types";
import { ytid } from "@/lib/utils";
import { PlayIcon, SCIcon } from "@/components/icons";

export default function Thumb({ row }: { row: Row }) {
  const id=ytid(row.youtube||undefined); const [loaded,setLoaded]=useState(false);
  if(id){const src=`https://img.youtube.com/vi/${id}/hqdefault.jpg`; return (<div className="relative w-full aspect-video overflow-hidden"><img src={src} alt={row.set} loading="lazy" onLoad={()=>setLoaded(true)} className={`w-full h-full object-cover transition-transform duration-300 group-hover:scale-[1.03] ${loaded?"blur-0":"blur-md"}`}/><div className="absolute inset-0 bg-gradient-to-t from-black/40 to-transparent opacity-80"/><div className="absolute inset-0 flex items-center justify-center"><div className="w-12 h-12 rounded-full bg-[var(--sodium)]/20 border border-[var(--sodium)]/60 grid place-items-center backdrop-blur-sm group-hover:shadow-[0_0_22px_rgba(183,255,46,0.3)] transition"><PlayIcon/></div></div></div>);}
  return (<div className="relative w-full aspect-video bg-gradient-to-br from-orange-600/40 to-fuchsia-600/30 grid place-items-center overflow-hidden"><div className="absolute inset-0 opacity-30 mix-blend-overlay" style={{backgroundImage:"radial-gradient(ellipse at center, transparent 50%, black 100%)"}}/><SCIcon className="w-12 h-12 opacity-80"/></div>);
}
```

## src/components/ui.tsx

```text
// src/components/ui.tsx
'use client';
import type { ReactNode } from "react";
import { motion } from 'framer-motion';

export function PageTitle({title}:{title:string}) {
  return <h2 className="text-center text-4xl sm:text-5xl font-semibold tracking-wide" style={{fontFamily:"'Space Grotesk',system-ui,sans-serif"}}>{title}</h2>;
}

export function IconButton({title,onClick,ariaLabel,children,variant}:{title:string;onClick?:()=>void;ariaLabel?:string;children:ReactNode;variant?:'default'|'inverted';}) {
  const v = variant||'default';
  const base = 'w-11 h-11 sm:w-8 sm:h-8 grid place-items-center rounded-full border focus-visible:outline-none focus-visible:ring-2';
  const cls = v==='inverted'
    ? `${base} border-black bg-black text-white hover:brightness-110 focus-visible:ring-black/40`
    : `${base} border-neutral-300 bg-white hover:bg-neutral-50 focus-visible:ring-black/30`;
  return (
    <motion.button title={title} aria-label={ariaLabel||title} onClick={onClick} className={cls}
      whileHover={{ y: -1, scale: 1.01 }}
      whileTap={{ y: 0, scale: 0.99 }}
    >
      {children}
    </motion.button>
  );
}

export function Pill({active,children,onClick}:{active:boolean;children:ReactNode;onClick:()=>void}) {
  return <button onClick={onClick} className={`h-7 px-3 rounded-full border text-sm ${active?"bg-neutral-900 text-white border-neutral-900":"bg-white border-neutral-300 hover:bg-neutral-50"}`}>{children}</button>;
}

export function Tag({children}:{children:ReactNode}) {
  return <span className="inline-flex items-center h-6 px-2 rounded-full border border-neutral-300 text-[12px] bg-white">{children}</span>;
}

/* improved spacing and travel */
export function Switch({checked,onChange}:{checked:boolean;onChange:()=>void}) {
  return (
    <button role="switch" aria-checked={checked} onClick={onChange}
      className={`relative inline-flex items-center w-12 h-7 rounded-full border transition
      ${checked?"bg-[var(--accent)] border-[var(--accent)]":"bg-neutral-200 border-neutral-300"} hover:brightness-[.98] focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-black/30`}>
      <i className={`absolute top-[4px] left-[4px] h-[18px] w-[18px] rounded-full bg-white shadow-sm transition-transform
        ${checked?"translate-x-[20px]":""}`}/>
    </button>
  );
}
```

## src/config.ts

```typescript
export const HEATMAP_IMAGES: { title: string; src: string; placeholder?: string }[] = [
  // { title: "Dekmantel 2025 – Saturday", src: "/heatmaps/dekmantel-2025-sat.png" },
];
```

## src/context/PlayerProvider.tsx

```text
'use client';
import { createContext, useContext, useEffect, useState, useCallback, useRef, type ReactNode } from "react";
import type { Provider, Row } from "@/lib/types";

type QueueItem={row:Row;provider:Provider};
type PlayerController={ play:()=>void; pause:()=>void; seek:(seconds:number)=>void };
type PlayerState={
  current:QueueItem|null;
  queue:QueueItem[];
  playing:boolean;
  progress:number; // 0..1
  open:boolean;
  durationSec:number; // absolute duration in seconds (if known)
  play:(row:Row,preferred?:Provider)=>void;
  toggle:()=>void;
  enqueue:(row:Row,preferred?:Provider)=>void;
  next:()=>void;
  setOpen:(v:boolean)=>void;
  // Live-sync plumbing used by provider-aware players (YouTube/SC)
  registerController:(ctrl:PlayerController|null)=>void;
  setProgressAbs:(elapsedSec:number,totalSec:number)=>void;
  setPlayingState:(value:boolean)=>void;
};
const Ctx=createContext<PlayerState|null>(null);
export const usePlayer=()=>{const v=useContext(Ctx); if(!v) throw new Error("Player provider missing"); return v;};

const pick=(row:Row,preferred?:Provider):Provider=>preferred==='youtube'&&row.youtube?'youtube':preferred==='soundcloud'&&row.soundcloud?'soundcloud':row.soundcloud?'soundcloud':'youtube';

export function PlayerProvider({children}:{children:ReactNode}){
  const [current,setCurrent]=useState<QueueItem|null>(null),[queue,setQueue]=useState<QueueItem[]>([]),[playing,setPlaying]=useState(false),[progress,setProgress]=useState(0),[open,setOpen]=useState(false);
  // Default duration used for simulated progress + UI, overridden by live players
  const [durationSec,setDurationSec]=useState<number>(48*60 + 36);
  // When a live player registers, we stop simulating clock and delegate play/pause to it
  const controllerRef=useRef<PlayerController|null>(null);
  const [hasController,setHasController]=useState(false);
  // Gate fallback clock while switching tracks so we don't show misleading time
  const [expectingController,setExpectingController]=useState(false);

  // Fallback simulated clock only if no external controller is available
  useEffect(()=>{
    if(!playing || hasController || expectingController) return; // external clock or waiting for one
    let raf=0,last=performance.now();
    const step=(now:number)=>{const dt=(now-last)/1000; last=now; setProgress(p=>Math.max(0,Math.min(1,(p+dt/Math.max(1,durationSec))%1))); raf=requestAnimationFrame(step);};
    raf=requestAnimationFrame(step);
    return()=>cancelAnimationFrame(raf);
  },[playing,hasController,expectingController,durationSec]);
  const play=useCallback((row:Row,preferred?:Provider)=>{
    // Reset prior controller and progress when switching
    try{ controllerRef.current?.pause(); }catch{}
    controllerRef.current=null; setHasController(false);
    setProgress(0); setDurationSec(0); setExpectingController(true);
    // Auto-clear expectation after short grace if no controller mounts
    setTimeout(()=>setExpectingController(false), 1500);
    setCurrent({row,provider:pick(row,preferred)});
    setPlaying(true);
    setOpen(true);
  },[]);
  const toggle=useCallback(()=>{
    setPlaying(v=>{
      const next=!v;
      const ctrl=controllerRef.current;
      if(ctrl){ if(next) ctrl.play(); else ctrl.pause(); }
      return next;
    });
  },[]);
  const enqueue=useCallback((row:Row,preferred?:Provider)=>setQueue(q=>[...q,{row,provider:pick(row,preferred)}]),[]);
  const next=useCallback(()=>setQueue(q=>{const n=q[0]; if(n){
    try{ controllerRef.current?.pause(); }catch{}
    controllerRef.current=null; setHasController(false);
    setProgress(0); setDurationSec(0); setExpectingController(true);
    setTimeout(()=>setExpectingController(false), 1500);
    setCurrent(n); setPlaying(true); setOpen(true); return q.slice(1);
  } setPlaying(false); return q;}),[]);
  useEffect(()=>{document.documentElement.style.setProperty("--playPulse",playing?"1":"0");},[playing]);
  // Removed defensive reset on current change to avoid racing real provider updates

  // Exposed helpers for live players
  const registerController=useCallback((ctrl:PlayerController|null)=>{
    controllerRef.current=ctrl;
    setHasController(!!ctrl);
    if (ctrl) setExpectingController(false);
  },[]);
  const setProgressAbs=useCallback((elapsedSec:number,totalSec:number)=>{
    const total=Math.max(1,Math.floor(totalSec||0));
    const cur=Math.max(0,Math.floor(elapsedSec||0));
    setDurationSec(total);
    setProgress(total>0? Math.min(1, cur/total) : 0);
  },[]);
  const setPlayingState=useCallback((value:boolean)=>{ setPlaying(value); },[]);

  return (
    <Ctx.Provider value={{
      current,queue,playing,progress,open,durationSec,
      play,toggle,enqueue,next,setOpen,
      registerController,setProgressAbs,setPlayingState
    }}>
      {children}
    </Ctx.Provider>
  );
}
```

## tsconfig.json

```json
{
  "compilerOptions": {
    "target": "ES2017",
    "lib": ["dom", "dom.iterable", "esnext"],
    "allowJs": true,
    "skipLibCheck": true,
    "strict": true,
    "noEmit": true,
    "esModuleInterop": true,
    "module": "esnext",
    "moduleResolution": "bundler",
    "resolveJsonModule": true,
    "isolatedModules": true,
    "jsx": "preserve",
    "incremental": true,
    "plugins": [
      {
        "name": "next"
      }
    ],
    "paths": {
      "@/*": ["./src/*"]
    }
  },
  "include": ["next-env.d.ts", "**/*.ts", "**/*.tsx", ".next/types/**/*.ts"],
  "exclude": ["node_modules"]
}
```

## Statistics

- Total Files: 29
- Total Characters: 136773
- Total Tokens: 0
